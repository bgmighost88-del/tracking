<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تتبع صرف علاج وصفتي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel Export AND Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f7f9fb; }
        #medicationSuggestions::-webkit-scrollbar, #userSuggestions::-webkit-scrollbar, #pharmacySuggestions::-webkit-scrollbar { display: none; }
        #medicationSuggestions, #userSuggestions, #pharmacySuggestions { -ms-overflow-style: none; scrollbar-width: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input:disabled, select:disabled, button:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7;}
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        // ===================================================================================
        // Firebase Configuration
        // ===================================================================================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        // *** تحسين: تم استيراد collectionGroup للاستعلامات المجمعة ***
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, getDocs, setDoc, query, where, getDoc, writeBatch, collectionGroup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const _0x4e3bf4=_0x3840;function _0x5efa(){const _0x31d73e=['medications','User\x20report\x20error:','UP72','checkPrescriptionButton','summaryReportTable','dispenseView','202286hxeIhh','ملف\x20الإكسيل\x20فارغ\x20أو\x20غير\x20صحيح.','summaryReportButton','sheet_to_json','يرجى\x20إدخال\x20اسم\x20المريض.','لا\x20يوجد\x20شيء\x20للحذف.','366894RaygNs','pharmacies','createElement','/records/','<p\x20class=\x22text-sm\x20text-gray-400\x22>لم\x20يتم\x20اختيار\x20أي\x20علاج\x20بعد.</p>','availableMedications','border-blue-600','resultsModal','PrescriptionNumber','تم\x20حذف\x20','bg-green-100\x20text-green-700','value','addMedicationButton','clear','endDateFilter','removeItem','add','؟\x20لا\x20يمكن\x20التراجع\x20عن\x20هذا\x20الإجراء.','textContent','143484qLjQjs','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20font-bold\x22>','entries','key','confirmMedDeleteButton','summaryReportEndDate','getDate','الفترة:\x20من\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22inline-flex\x20items-center\x20px-3\x20py-1\x20m-1\x20text-sm\x20bg-blue-100\x20text-blue-800\x20rounded-full\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>','loginForm','للدخول\x20كمدير،\x20يرجى\x20اختيار\x20\x22Admin\x22\x20من\x20قائمة\x20الصيدليات.','لا\x20يوجد','تقرير_صرف_المستخدم_','deleteAllExpiredButton','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','<hr\x20class=\x22my-2\x20border-y-green-300\x22><p\x20class=\x22text-sm\x22><strong>صيدلياتك:</strong>\x20','6tKGXmO','يرجى\x20اختيار\x20الصيدلية\x20التي\x20سيتم\x20الاستيراد\x20إليها\x20أولاً.','يرجى\x20اختيار\x20ملف\x20أولاً\x20للبدء.','Invalid\x20date\x20range.','role','</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','now','\x27)\x22\x20class=\x22bg-red-500\x20hover:bg-red-600\x20text-white\x20text-xs\x20font-bold\x20py-1\x20px-3\x20rounded-full\x22>حذف</button></td>','فشل\x20حذف\x20الوصفات\x20المنتهية.','تم\x20العثور\x20على\x20بيانات\x20المريض.','dispensingDate','<td\x20class=\x22px-6\x20py-4\x22>','Submit\x20Error:','admin','remove','تم\x20تسجيل\x20إعادة\x20الصرف\x20بنجاح!','loadingStatus','historyPatientName','userName','noRefillReportTable','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20font-semibold\x20text-purple-700\x22>','فشل\x20الاستيراد:\x20','green','keys','SheetNames','set','فشل\x20جلب\x20البيانات.\x20حدث\x20خطأ\x20غير\x20متوقع.','userReportModalBody','setItem','أدخل\x20رقم\x20الوصفة','split','pharmacies/','w-full\x20flex\x20justify-center\x20items-center\x20py-3\x20px-4\x20rounded-lg\x20shadow-md\x20text-white\x20bg-green-600\x20hover:bg-green-700','push','1872282okpuHA','bg-blue-100\x20text-blue-700','pharmacyId','AIzaSyBshSGBdGiiCMtqC3Z16_w6xWPfv-xjTq8','noResultsUserReport','startDateFilter','adminPharmacySelectorContainer','dispenserHeader','dispense','userReportInfo','length','result','removeMedication','span','adminDataCacheTimestamp','wasfatytracking.appspot.com','onclick','loginContainer','reduce','313','3322476rFQRQa','excelFile','</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20text-center\x22>','المستخدم:\x20','closeReportModalButton','Medications','bg-white\x20hover:bg-gray-50','email','Toujeo','</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22button\x22\x20class=\x22rtl:mr-2\x20ltr:ml-2\x20text-blue-500\x20hover:text-blue-700\x22\x20onclick=\x22removeMedication(','.xlsx','/records','confirmDeleteModal','delete','userReportButton','string','125885PVIQpc','yellow','reportModal','DispensingDate','summaryReportStartDate','Novomix','غير\x20معروف','accessiblePharmacies','#medicationInputArea','usernameInput','summaryReportInfo','Sensor','userReportModal','تقرير_الوصفات_المنتهية_','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20font-semibold\x22>','noRefillReportButton','createdByHeader','56xuctnf','dispensingHistory','Failed\x20to\x20fetch\x20data\x20for\x20report.','لم\x20يتم\x20اختيار\x20أي\x20ملف','<span\x20class=\x22inline-block\x20bg-gray-200\x20text-gray-800\x20text-xs\x20px-2\x20py-0.5\x20rounded-full\x20m-0.5\x22>','date','superadmin','messageBox','pharmacyIdInput','reportCreatedByHeader','pharmacySuggestions','خطأ:\x20لم\x20يتم\x20العثور\x20على\x20جدول\x20التقرير\x20للتصدير.','confirmDeleteMedication','sort','confirmDeleteMessage','userInfo','</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','adminPharmacyList','حفظ\x20سجل\x20صرف\x20جديد','\x20سجل\x20(بيانات\x20ناقصة\x20أو\x20وصفات\x20مكررة).','Sheet1','استيراد','يرجى\x20إدخال\x20تاريخ\x20الصرف.','<div\x20class=\x22loader\x20mx-auto\x22></div>\x20<span>جاري\x20الاستيراد\x20والتحقق...</span>','generalSearchFilter','excelImportContainer','footerCloseUserReportModalButton','join','summaryReportSummary','footerCloseSummaryReportModalButton','closest','<span\x20class=\x22inline-block\x20bg-blue-100\x20text-blue-800\x20text-xs\x20font-medium\x20px-2.5\x20py-0.5\x20rounded-full\x20m-0.5\x22>','الوصفة\x20غير\x20مسجلة\x20من\x20قبل.\x20يمكنك\x20إدخال\x20البيانات\x20يدويًا.','footerCloseReportModalButton','confirmMedDeleteModal','refillDate','لم\x20يتم\x20استيراد\x20أي\x20سجلات.\x20يرجى\x20مراجعة\x20بيانات\x20الملف.','إجمالي\x20عدد\x20الوصفات\x20المصروفة:\x20','</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-6\x20py-4\x22>','filter','userReportSelector','innerHTML','</span>','My\x20Report','loggedInUserDisplay','getElementById','navDispense','medicationFilter','closeResultsModalButton','تم\x20استيراد\x20','IdNumber','RefillDuration','exportUserReportButton','parent','confirmDeleteButton','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20text-center\x22>','<td\x20class=\x22px-4\x20py-3\x22>','Sheets','click','p-1\x20rounded-full\x20flex-shrink-0','target','\x20وصفة\x20منتهية\x20بنجاح.','\x20|\x20الفترة:\x20','forEach','test','some','\x20يوم','تم\x20تخطي\x20','PhoneNumber','padStart','خطأ\x20في\x20تحميل\x20قائمة\x20المستخدمين\x20للتقرير.','Error\x20populating\x20user\x20selector:','classList','addEventListener','setDate','localeCompare','stopPropagation','تاريخ\x20البداية\x20يجب\x20أن\x20يكون\x20قبل\x20تاريخ\x20النهاية.','User\x20Reports','option','Delete\x20Error:','pharmacyDisplayContainer','عرض\x20كل\x20الصيدليات\x20(للمدير)','UP74','\x22\x20من\x20القائمة\x20الرئيسية؟\x20سيتم\x20حذفه\x20نهائياً.','text-blue-600','حدث\x20خطأ\x20أثناء\x20إنشاء\x20التقرير.','عرض\x20التقرير','Medication\x20Delete\x20Error:','getItem','[id$=\x22Modal\x22]','commit','appContainer','refillDuration','onload','bg-white\x20border-b\x20hover:bg-gray-50','placeholder','contains','unshift','w-full\x20flex\x20justify-center\x20items-center\x20py-3\x20px-4\x20rounded-lg\x20shadow-md\x20text-white\x20bg-blue-900\x20hover:bg-blue-700','هذه\x20الوصفة\x20ليس\x20لها\x20إعادة\x20صرف.','adminViewMessage','إعادة\x20صرف','adminDataCache','files','patientName','Escape','بحث','focus','summaryReportContainer','ليس\x20لديك\x20صلاحية\x20الدخول\x20لهذه\x20الصيدلية.','No\x20refill\x20report\x20error:','idNumber','map','error','undefined','opacity-50','Lantus','Failed\x20to\x20fetch\x20data.','\x27,\x20\x27','createdBy','searchButton','footerCloseHistoryModalButton','passwordInput','Failed\x20to\x20fetch\x20data\x20for\x20deletion.','user','تم\x20العثور\x20على\x20الوصفة\x20المسجلة\x20','currentUser','</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x22>','subadmin','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-6\x20py-4\x22>','userReportEndDate','hidden','blur','replace','confirmBulkDeleteMessage','Admin','footerCloseResultsModalButton','Novorapid','px-4\x20py-2\x20cursor-pointer\x20hover:bg-blue-100\x20text-sm','dispensedBy','report.xlsx','has','keypress','تحقق','userReportSummary','Error\x20listening\x20for\x20records:','تم\x20حفظ\x20السجل\x20الجديد\x20بنجاح!','أدخل\x20رقم\x20الوصفة\x20للبحث\x20أو\x20الصرف','border-b\x20','1:580236981063:web:bac34b55427f3450b89262','phoneNumber','medicationSearch','\x27)\x22\x20class=\x22bg-blue-500\x20hover:bg-blue-600\x20text-white\x20text-xs\x20py-1\x20px-3\x20rounded-full\x22>عرض\x20(','isArray','modalRecordsBody','bg-green-50\x20font-semibold','includes','reportModalBody','bg-yellow-100\x20text-yellow-700','count','exportSummaryReportButton','blue','medicationCount','records','summaryReportModalBody','className','عرض\x20تقريري','message','خطأ\x20في\x20جلب\x20بيانات\x20المريض.\x20قد\x20تحتاج\x20لإضافة\x20فهرس\x20في\x20قاعدة\x20البيانات.','<svg\x20class=\x22w-5\x20h-5\x20text-red-400\x20hover:text-red-600\x22\x20fill=\x22none\x22\x20stroke=\x22currentColor\x22\x20viewBox=\x220\x200\x2024\x2024\x22><path\x20stroke-linecap=\x22round\x22\x20stroke-linejoin=\x22round\x22\x20stroke-width=\x222\x22\x20d=\x22M19\x207l-.867\x2012.142A2\x202\x200\x200116.138\x2021H7.862a2\x202\x200\x2001-1.995-1.858L5\x207m5\x204v6m4-6v6m1-10V4a1\x201\x200\x2000-1-1h-4a1\x201\x200\x2000-1\x201v3M4\x207h16\x22></path></svg>','splice','تقرير_اداء_المستخدمين_','log','من\x20','red','كل\x20الفترات','</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-6\x20py-4\x20font-semibold\x20','يا\x20مدير،\x20يرجى\x20اختيار\x20صيدلية\x20أولاً.','#pharmacyInputArea','exportNoRefillReportButton','utils','userReportSelectorContainer','data','bg-red-100\x20text-red-700','Fetching\x20fresh\x20admin\x20data\x20from\x20Firestore.','UP313','adminPharmacySelector','--\x20/\x20--\x20/\x20----','حذف\x20كل\x20الوصفات\x20المنتهية','read','Autofill\x20Error:','pharmacyHeader','historyModal','580236981063','خطأ:\x20','Excel\x20Import\x20Error:','cancelMedDeleteButton','@pharmacy.com','summaryReportModal','border-transparent','disabled','toString','keydown','N/A','input','fileNameDisplay','medicationSuggestions','حدث\x20خطأ\x20أثناء\x20التحقق\x20من\x20الوصفة.\x20index:\x20','elements','تم\x20تسجيل\x20إعادة\x20الصرف\x20ونقل\x20السجل\x20للصيدلية\x20الجديدة\x20بنجاح!','PatientName','importExcelButton','prescriptionNumber','appendChild','</td>','confirmBulkDeleteModal','تم\x20العثور\x20على\x20بيانات\x20المريض\x20من\x20سجل\x20سابق.','toISOString','أنت\x20على\x20وشك\x20حذف\x20',').\x20لا\x20يمكنك\x20صرفها.','35424TsegMs','نعم،\x20قم\x20بالحذف','noResultsSummaryReport','readAsArrayBuffer','<div\x20class=\x22loader\x20mx-auto\x22></div>','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','find','يرجى\x20إدخال\x20رقم\x20الهوية.','هل\x20أنت\x20متأكد\x20من\x20حذف\x20دواء:\x20\x22','<div\x20class=\x22flex\x20justify-center\x20items-center\x20gap-2\x22><div\x20class=\x22loader\x22></div><span>جاري\x20تحميل\x20البيانات...</span></div>','toggle','Enter','change','durationDays','submitButton',')\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<svg\x20class=\x22w-4\x20h-4\x22\x20fill=\x22none\x22\x20stroke=\x22currentColor\x22\x20viewBox=\x220\x200\x2024\x2024\x22><path\x20stroke-linecap=\x22round\x22\x20stroke-linejoin=\x22round\x22\x20stroke-width=\x222\x22\x20d=\x22M6\x2018L18\x206M6\x206l12\x2012\x22></path></svg>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','closeHistoryModalButton','flex','<option\x20value=\x22\x22\x20disabled\x20selected>--\x20اختر\x20الصيدلية\x20--</option>','div','parse','writeFile','text-red-600','كل\x20المستخدمين','toLowerCase','confirmBulkDeleteButton','docs','</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x22>','preventDefault','empty','text-green-600','يجب\x20اختيار\x20علاج\x20واحد\x20على\x20الأقل.','<option\x20value=\x22\x22>--\x20كل\x20المستخدمين\x20--</option>','text-gray-500','الوصفة\x20مسجلة\x20بصيدلية\x20أخرى\x20(','trim','خطأ\x20في\x20تحديد\x20الوصفات\x20المنتهية.','ref','تم\x20حذف\x20السجل\x20بنجاح.','stringify','clearSearchButton','slice','يرجى\x20اختيار\x20فترة\x20الإعادة.'];_0x5efa=function(){return _0x31d73e;};return _0x5efa();}(function(_0x577cca,_0x336c36){const _0xb7ffe5=_0x3840,_0x480458=_0x577cca();while(!![]){try{const _0x7357d9=-parseInt(_0xb7ffe5(0x16e))/0x1+-parseInt(_0xb7ffe5(0x174))/0x2+parseInt(_0xb7ffe5(0x197))/0x3*(-parseInt(_0xb7ffe5(0x187))/0x4)+-parseInt(_0xb7ffe5(0x1dd))/0x5+parseInt(_0xb7ffe5(0x1b9))/0x6+-parseInt(_0xb7ffe5(0x1ee))/0x7*(parseInt(_0xb7ffe5(0x13d))/0x8)+parseInt(_0xb7ffe5(0x1cd))/0x9;if(_0x7357d9===_0x336c36)break;else _0x480458['push'](_0x480458['shift']());}catch(_0x2cb984){_0x480458['push'](_0x480458['shift']());}}}(_0x5efa,0x27d3f));const firebaseConfig={'apiKey':_0x4e3bf4(0x1bc),'authDomain':'wasfatytracking.firebaseapp.com','projectId':'wasfatytracking','storageBucket':_0x4e3bf4(0x1c8),'messagingSenderId':_0x4e3bf4(0x122),'appId':_0x4e3bf4(0x284)},app=initializeApp(firebaseConfig),db=getFirestore(app),auth=getAuth(app),PHARMACY_LIST={'313':_0x4e3bf4(0x11a),'74':_0x4e3bf4(0x241),'72':_0x4e3bf4(0x16a)},USER_ROLES={'admin':{'role':'superadmin'},'dmin1':{'role':_0x4e3bf4(0x1f4)},'admin2':{'role':_0x4e3bf4(0x1f4)},'admin.hany':{'role':_0x4e3bf4(0x26f),'pharmacies':['313','74']},'admin.mohamed':{'role':_0x4e3bf4(0x26f),'pharmacies':['72']},'up313':{'role':_0x4e3bf4(0x26b),'pharmacies':[_0x4e3bf4(0x1cc)]},'up074':{'role':_0x4e3bf4(0x26b),'pharmacies':['74']},'up072':{'role':_0x4e3bf4(0x26b),'pharmacies':['2','72']}};let records=[],allPharmaciesRecords=[],isDataFetchedForAdmin=![],currentMedications=[],currentRecord=null,AVAILABLE_MEDICATIONS=[],unsubscribeFromRecords=null,recordIdToDelete=null,pharmacyIdToDeleteFrom=null,currentUser={'role':null,'pharmacyId':null,'accessiblePharmacies':[]},medNameToDelete=null,selectedFileForImport=null;const CACHE_DURATION_MS=0xf*0x3c*0x3e8,loginContainer=()=>document[_0x4e3bf4(0x21b)](_0x4e3bf4(0x1ca)),appContainer=()=>document[_0x4e3bf4(0x21b)](_0x4e3bf4(0x24a)),getAccessiblePharmacies=()=>{const _0x213653=_0x4e3bf4;if(currentUser['role']==='superadmin')return Object[_0x213653(0x1ae)](PHARMACY_LIST);return currentUser[_0x213653(0x1e4)]||[];},showApp=_0x251232=>{const _0x5baefe=_0x4e3bf4,_0x2b4352=[_0x5baefe(0x1f4),'subadmin'][_0x5baefe(0xfd)](currentUser[_0x5baefe(0x19b)]);loginContainer()[_0x5baefe(0x236)]['add'](_0x5baefe(0x272)),appContainer()[_0x5baefe(0x236)]['remove'](_0x5baefe(0x272)),document[_0x5baefe(0x21b)](_0x5baefe(0x21a))[_0x5baefe(0x186)]=_0x251232[_0x5baefe(0x1d4)][_0x5baefe(0x1b5)]('@')[0x0];const _0x3dbd39=document['getElementById'](_0x5baefe(0x23f));if(_0x2b4352)_0x3dbd39[_0x5baefe(0x236)]['add'](_0x5baefe(0x272));else{_0x3dbd39[_0x5baefe(0x236)][_0x5baefe(0x1a5)](_0x5baefe(0x272));let _0x4b65c9='';currentUser[_0x5baefe(0x1bb)]&&(_0x4b65c9=PHARMACY_LIST[currentUser['pharmacyId']]||currentUser[_0x5baefe(0x1bb)]),document['getElementById']('pharmacyIdDisplay')[_0x5baefe(0x186)]=_0x4b65c9;}document[_0x5baefe(0x21b)](_0x5baefe(0x1fd))['classList'][_0x5baefe(0x1a5)]('hidden'),document['getElementById']('userReportButton')['textContent']=_0x2b4352?_0x5baefe(0x23c):_0x5baefe(0x219);currentUser[_0x5baefe(0x19b)]===_0x5baefe(0x1f4)?document[_0x5baefe(0x21b)]('summaryReportContainer')[_0x5baefe(0x236)][_0x5baefe(0x1a5)](_0x5baefe(0x272)):document[_0x5baefe(0x21b)](_0x5baefe(0x25b))[_0x5baefe(0x236)][_0x5baefe(0x184)](_0x5baefe(0x272));if(_0x2b4352){document[_0x5baefe(0x21b)](_0x5baefe(0x253))['classList']['remove'](_0x5baefe(0x272)),document[_0x5baefe(0x21b)](_0x5baefe(0x1bf))[_0x5baefe(0x236)]['remove'](_0x5baefe(0x272)),document[_0x5baefe(0x21b)]('userReportSelectorContainer')[_0x5baefe(0x236)][_0x5baefe(0x1a5)](_0x5baefe(0x272)),document[_0x5baefe(0x21b)](_0x5baefe(0x207))[_0x5baefe(0x236)][_0x5baefe(0x1a5)]('hidden'),document[_0x5baefe(0x21b)](_0x5baefe(0x194))['classList']['remove']('hidden');const _0x3db9bb=document['getElementById'](_0x5baefe(0x11b));_0x3db9bb[_0x5baefe(0x217)]=_0x5baefe(0x14f);const _0x492ae7=getAccessiblePharmacies();_0x492ae7[_0x5baefe(0x22d)](_0x5d16a1=>{const _0x1a69bc=_0x5baefe,_0x16712a=PHARMACY_LIST[_0x5d16a1];if(_0x16712a){const _0x3f51ca=document[_0x1a69bc(0x176)](_0x1a69bc(0x23d));_0x3f51ca[_0x1a69bc(0x17f)]=_0x5d16a1,_0x3f51ca[_0x1a69bc(0x186)]=_0x16712a+'\x20('+_0x5d16a1+')',_0x3db9bb['appendChild'](_0x3f51ca);}});if(currentUser[_0x5baefe(0x19b)]===_0x5baefe(0x26f)){const _0x58193e=currentUser[_0x5baefe(0x1e4)][_0x5baefe(0x25f)](_0x5adac6=>PHARMACY_LIST[_0x5adac6]+'\x20('+_0x5adac6+')')[_0x5baefe(0x209)](',\x20');document[_0x5baefe(0x21b)](_0x5baefe(0x1ff))['innerHTML']=_0x5baefe(0x196)+_0x58193e+'</p>';}else document['getElementById']('adminPharmacyList')[_0x5baefe(0x217)]='';populateUserReportSelector(),document['getElementById']('prescriptionNumber')[_0x5baefe(0x24e)]=_0x5baefe(0x282);}else document[_0x5baefe(0x21b)](_0x5baefe(0x253))['classList']['add']('hidden'),document[_0x5baefe(0x21b)](_0x5baefe(0x1bf))[_0x5baefe(0x236)]['add'](_0x5baefe(0x272)),document[_0x5baefe(0x21b)](_0x5baefe(0x116))[_0x5baefe(0x236)]['add'](_0x5baefe(0x272)),document[_0x5baefe(0x21b)](_0x5baefe(0x207))['classList'][_0x5baefe(0x184)](_0x5baefe(0x272)),document['getElementById'](_0x5baefe(0x194))[_0x5baefe(0x236)][_0x5baefe(0x184)](_0x5baefe(0x272)),document[_0x5baefe(0x21b)](_0x5baefe(0x135))[_0x5baefe(0x24e)]=_0x5baefe(0x1b4);navigateTo(_0x5baefe(0x1c1));},showLogin=()=>{const _0x838d0e=_0x4e3bf4;appContainer()['classList']['add'](_0x838d0e(0x272)),loginContainer()['classList'][_0x838d0e(0x1a5)](_0x838d0e(0x272)),document[_0x838d0e(0x21b)](_0x838d0e(0x1fd))[_0x838d0e(0x236)]['add']('hidden'),currentUser={'role':null,'pharmacyId':null,'accessiblePharmacies':[]};},handleLogout=async()=>{const _0x54e867=_0x4e3bf4;if(unsubscribeFromRecords)unsubscribeFromRecords();records=[],allPharmaciesRecords=[],isDataFetchedForAdmin=![],sessionStorage[_0x54e867(0x183)](_0x54e867(0x255)),sessionStorage['removeItem'](_0x54e867(0x1c7)),resetFormState(!![]),await signOut(auth);},handleLogin=async _0x472ff8=>{const _0x4c9673=_0x4e3bf4;_0x472ff8[_0x4c9673(0x159)]();const _0x4bec04=document[_0x4c9673(0x21b)](_0x4c9673(0x1f6))[_0x4c9673(0x17f)][_0x4c9673(0x160)](),_0x282af8=document[_0x4c9673(0x21b)](_0x4c9673(0x1e6))[_0x4c9673(0x17f)]['trim']()['toLowerCase'](),_0x28ff3e=_0x282af8+_0x4c9673(0x126),_0x96b9e1=document['getElementById'](_0x4c9673(0x269))['value'],_0x5ad9b0=document[_0x4c9673(0x21b)]('loginError');_0x5ad9b0[_0x4c9673(0x236)][_0x4c9673(0x184)](_0x4c9673(0x272));const _0x15ad07=USER_ROLES[_0x282af8];if(!_0x15ad07)return _0x5ad9b0[_0x4c9673(0x186)]='اسم\x20المستخدم\x20غير\x20موجود.',_0x5ad9b0[_0x4c9673(0x236)][_0x4c9673(0x1a5)](_0x4c9673(0x272));if(_0x15ad07[_0x4c9673(0x19b)]===_0x4c9673(0x26b)){if(!_0x4bec04||!_0x15ad07[_0x4c9673(0x175)]['includes'](_0x4bec04))return _0x5ad9b0[_0x4c9673(0x186)]=_0x4c9673(0x25c),_0x5ad9b0[_0x4c9673(0x236)]['remove']('hidden');sessionStorage['setItem'](_0x4c9673(0x1bb),_0x4bec04);}else{if([_0x4c9673(0x1f4),'subadmin'][_0x4c9673(0xfd)](_0x15ad07[_0x4c9673(0x19b)])){if(_0x4bec04['toLowerCase']()!==_0x4c9673(0x1a4))return _0x5ad9b0[_0x4c9673(0x186)]=_0x4c9673(0x191),_0x5ad9b0[_0x4c9673(0x236)][_0x4c9673(0x1a5)](_0x4c9673(0x272));sessionStorage[_0x4c9673(0x1b3)](_0x4c9673(0x1bb),_0x4c9673(0x276));}}sessionStorage[_0x4c9673(0x1b3)]('userRole',_0x15ad07['role']);_0x15ad07[_0x4c9673(0x175)]&&sessionStorage[_0x4c9673(0x1b3)](_0x4c9673(0x1e4),JSON[_0x4c9673(0x164)](_0x15ad07['pharmacies']));try{await signInWithEmailAndPassword(auth,_0x28ff3e,_0x96b9e1);}catch(_0x15289f){sessionStorage[_0x4c9673(0x181)](),_0x5ad9b0['textContent']='بيانات\x20تسجيل\x20الدخول\x20غير\x20صحيحة.',_0x5ad9b0[_0x4c9673(0x236)][_0x4c9673(0x1a5)](_0x4c9673(0x272));}};onAuthStateChanged(auth,_0x29ff64=>{const _0x352351=_0x4e3bf4;if(_0x29ff64){const _0x38a2f1=sessionStorage['getItem']('pharmacyId'),_0x55df6b=sessionStorage[_0x352351(0x247)]('userRole'),_0x3a5730=sessionStorage[_0x352351(0x247)]('accessiblePharmacies');_0x38a2f1&&_0x55df6b?(currentUser[_0x352351(0x1bb)]=_0x38a2f1,currentUser['role']=_0x55df6b,currentUser[_0x352351(0x1e4)]=_0x3a5730?JSON['parse'](_0x3a5730):[],appContainer()['classList'][_0x352351(0x24f)](_0x352351(0x272))&&(showApp(_0x29ff64),initApp())):handleLogout();}else showLogin(),sessionStorage[_0x352351(0x181)]();});const loadAvailableMedsFromFirestore=async()=>{const _0x10ccaa=_0x4e3bf4;try{const _0x199408=await getDocs(collection(db,_0x10ccaa(0x179)));AVAILABLE_MEDICATIONS=_0x199408[_0x10ccaa(0x157)][_0x10ccaa(0x25f)](_0xb9b9f5=>_0xb9b9f5['id'])[_0x10ccaa(0x1fb)]((_0x245fd9,_0x3b860a)=>_0x245fd9[_0x10ccaa(0x239)](_0x3b860a,'ar'));}catch(_0x20af78){console[_0x10ccaa(0x260)]('Error\x20loading\x20meds:',_0x20af78),AVAILABLE_MEDICATIONS=[_0x10ccaa(0x1e8),_0x10ccaa(0x278),_0x10ccaa(0x263),_0x10ccaa(0x1d5),_0x10ccaa(0x1e2)];}},listenForRecords=()=>{const _0x464c5d=_0x4e3bf4;if(unsubscribeFromRecords)unsubscribeFromRecords();if(['superadmin','subadmin']['includes'](currentUser['role'])){console[_0x464c5d(0x10d)]('Admin\x20view\x20active.\x20Data\x20will\x20be\x20fetched\x20on\x20demand.'),records=[];return;}if(!currentUser['pharmacyId'])return;const _0x4af0b1=_0x464c5d(0x1b6)+currentUser[_0x464c5d(0x1bb)]+'/records',_0x1a37a6=query(collection(db,_0x4af0b1));unsubscribeFromRecords=onSnapshot(_0x1a37a6,_0x320aca=>{const _0x46cb11=_0x464c5d;records=_0x320aca[_0x46cb11(0x157)][_0x46cb11(0x25f)](_0x2a3896=>({'id':_0x2a3896['id'],'pharmacyId':currentUser[_0x46cb11(0x1bb)],..._0x2a3896['data']()}));},_0x463ca2=>console[_0x464c5d(0x260)](_0x464c5d(0x280),_0x463ca2));},addMedicationToFirestore=async _0x4d9c1c=>{const _0x56baff=_0x4e3bf4;try{await setDoc(doc(db,_0x56baff(0x179),_0x4d9c1c),{'name':_0x4d9c1c});}catch(_0x2545df){console[_0x56baff(0x260)]('Error\x20adding\x20med:',_0x2545df);}},getRecordsForCurrentUserScope=async(_0x18907c=![])=>{const _0x106c92=_0x4e3bf4,_0x52ca9b=sessionStorage[_0x106c92(0x247)](_0x106c92(0x255)),_0x36646f=sessionStorage[_0x106c92(0x247)](_0x106c92(0x1c7));if(!_0x18907c&&_0x52ca9b&&_0x36646f&&Date['now']()-parseInt(_0x36646f,0xa)<CACHE_DURATION_MS)return console[_0x106c92(0x10d)]('Loading\x20admin\x20data\x20from\x20cache.'),allPharmaciesRecords=JSON[_0x106c92(0x151)](_0x52ca9b),isDataFetchedForAdmin=!![],allPharmaciesRecords;if(isDataFetchedForAdmin&&!_0x18907c)return allPharmaciesRecords;document[_0x106c92(0x21b)]('loadingStatus')[_0x106c92(0x217)]=_0x106c92(0x146);try{console[_0x106c92(0x10d)](_0x106c92(0x119));const _0x109d6d=[],_0x10df8b=getAccessiblePharmacies();for(const _0x50f520 of _0x10df8b){const _0x512a8a=_0x106c92(0x1b6)+_0x50f520+_0x106c92(0x1d8),_0x536577=await getDocs(collection(db,_0x512a8a));_0x536577[_0x106c92(0x22d)](_0x268ecc=>{const _0xc2d751=_0x106c92;_0x109d6d[_0xc2d751(0x1b8)]({'id':_0x268ecc['id'],'pharmacyId':_0x50f520,..._0x268ecc[_0xc2d751(0x117)]()});});}return allPharmaciesRecords=_0x109d6d,isDataFetchedForAdmin=!![],sessionStorage[_0x106c92(0x1b3)]('adminDataCache',JSON['stringify'](_0x109d6d)),sessionStorage['setItem'](_0x106c92(0x1c7),Date[_0x106c92(0x19d)]()[_0x106c92(0x12a)]()),allPharmaciesRecords;}catch(_0x5adb15){return console['error']('Scoped\x20data\x20fetch\x20error:',_0x5adb15),showMessage(_0x106c92(0x1b1),'red'),isDataFetchedForAdmin=![],null;}finally{document['getElementById'](_0x106c92(0x1a7))[_0x106c92(0x217)]='';}},initApp=async()=>{const _0x243aa0=_0x4e3bf4;document[_0x243aa0(0x21b)](_0x243aa0(0x1a7))[_0x243aa0(0x217)]='',await loadAvailableMedsFromFirestore(),listenForRecords(),setupSearchableDropdown(),calculateRefillDate(),renderCurrentMedications(),resetFormState(!![]);},getLatestDispensing=_0x5857b4=>{const _0x3cef7e=_0x4e3bf4;if(!_0x5857b4?.[_0x3cef7e(0x1ef)]?.['length'])return null;return[..._0x5857b4[_0x3cef7e(0x1ef)]][_0x3cef7e(0x1fb)]((_0x1e2079,_0x2d9182)=>new Date(_0x2d9182[_0x3cef7e(0x1a1)])-new Date(_0x1e2079[_0x3cef7e(0x1a1)]))[0x0];},formatDate=_0x4de98d=>{const _0xb7c758=_0x4e3bf4;if(!(_0x4de98d instanceof Date)||isNaN(_0x4de98d))return null;const _0x570b5f=_0x4de98d['getFullYear'](),_0x33dfdd=String(_0x4de98d['getMonth']()+0x1)[_0xb7c758(0x233)](0x2,'0'),_0x540ff1=String(_0x4de98d[_0xb7c758(0x18d)]())[_0xb7c758(0x233)](0x2,'0');return _0x570b5f+'-'+_0x33dfdd+'-'+_0x540ff1;},showMessage=(_0x43b8b0,_0x1c9f54)=>{const _0x3ff1de=_0x4e3bf4,_0xead9e5=document[_0x3ff1de(0x21b)](_0x3ff1de(0x1f5));_0xead9e5['textContent']=_0x43b8b0,_0xead9e5['className']='p-3\x20mb-4\x20text-sm\x20rounded-lg\x20shadow-md\x20transition-all\x20duration-300';const _0x2b4b94={'green':_0x3ff1de(0x17e),'yellow':_0x3ff1de(0xff),'red':_0x3ff1de(0x118),'blue':_0x3ff1de(0x1ba)};_0xead9e5['classList']['add'](...(_0x2b4b94[_0x1c9f54]||'')['split']('\x20')),_0xead9e5[_0x3ff1de(0x236)][_0x3ff1de(0x1a5)](_0x3ff1de(0x272)),setTimeout(()=>{const _0x331bb5=_0x3ff1de;_0xead9e5[_0x331bb5(0x186)]===_0x43b8b0&&_0xead9e5[_0x331bb5(0x236)][_0x331bb5(0x184)](_0x331bb5(0x272));},0x1388);},showModal=_0x40d301=>document['getElementById'](_0x40d301)[_0x4e3bf4(0x236)][_0x4e3bf4(0x274)](_0x4e3bf4(0x272),_0x4e3bf4(0x14e)),closeModal=_0x1c72e4=>document['getElementById'](_0x1c72e4)[_0x4e3bf4(0x236)][_0x4e3bf4(0x274)](_0x4e3bf4(0x14e),'hidden'),navigateTo=_0x6b6c25=>{const _0x48c937=_0x4e3bf4;document['getElementById']('dispenseView')[_0x48c937(0x236)][_0x48c937(0x184)]('hidden');const _0x57b38f=document[_0x48c937(0x21b)](_0x48c937(0x21c));_0x57b38f[_0x48c937(0x236)][_0x48c937(0x1a5)]('text-blue-600',_0x48c937(0x17a)),_0x57b38f[_0x48c937(0x236)][_0x48c937(0x184)](_0x48c937(0x15e),_0x48c937(0x128)),_0x6b6c25===_0x48c937(0x1c1)&&(document[_0x48c937(0x21b)](_0x48c937(0x16d))[_0x48c937(0x236)]['remove']('hidden'),_0x57b38f[_0x48c937(0x236)][_0x48c937(0x184)](_0x48c937(0x243),_0x48c937(0x17a)),_0x57b38f['classList']['remove'](_0x48c937(0x15e),_0x48c937(0x128)));};window['showDispensingHistory']=(_0x1f6ffb,_0x2b3d21)=>{const _0x312761=_0x4e3bf4,_0x4126c8=[_0x312761(0x1f4),'subadmin'][_0x312761(0xfd)](currentUser[_0x312761(0x19b)])?allPharmaciesRecords:records,_0xe8dfc4=_0x4126c8[_0x312761(0x143)](_0x4f15c9=>_0x4f15c9['id']===_0x1f6ffb&&_0x4f15c9[_0x312761(0x1bb)]===_0x2b3d21);if(!_0xe8dfc4)return;const _0x462c90=document['getElementById']('historyModalBody'),_0x1e7a8e=document['getElementById'](_0x312761(0x1a8)),_0x3070fd=[..._0xe8dfc4[_0x312761(0x1ef)]][_0x312761(0x1fb)]((_0x136aa9,_0x49b388)=>new Date(_0x49b388[_0x312761(0x1a1)])-new Date(_0x136aa9[_0x312761(0x1a1)]));_0x462c90['innerHTML']='',_0x1e7a8e[_0x312761(0x186)]=_0xe8dfc4[_0x312761(0x257)],_0x3070fd[_0x312761(0x22d)]((_0x10fe91,_0x44c0fd)=>{const _0x11e4a6=_0x312761,_0x4f1dbe=_0x44c0fd===0x0,_0x3a6814=(_0x10fe91[_0x11e4a6(0x168)]||[])[_0x11e4a6(0x25f)](_0x17d7bb=>_0x11e4a6(0x1f2)+_0x17d7bb+_0x11e4a6(0x218))[_0x11e4a6(0x209)](''),_0x2247bf=_0x10fe91[_0x11e4a6(0x211)]===_0x11e4a6(0x12c)?_0x11e4a6(0x192):_0x10fe91[_0x11e4a6(0x211)],_0x105ead=document[_0x11e4a6(0x176)]('tr');_0x105ead['className']=_0x11e4a6(0x283)+(_0x4f1dbe?_0x11e4a6(0xfc):_0x11e4a6(0x1d3)),_0x105ead[_0x11e4a6(0x217)]=_0x11e4a6(0x225)+(_0x3070fd[_0x11e4a6(0x1c3)]-_0x44c0fd)+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20text-center\x22>'+_0x10fe91[_0x11e4a6(0x1a1)]+_0x11e4a6(0x1cf)+(_0x10fe91[_0x11e4a6(0x14a)]>0x0?_0x10fe91[_0x11e4a6(0x14a)]+_0x11e4a6(0x230):'N/A')+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20text-center\x20'+(!_0x4f1dbe&&_0x10fe91[_0x11e4a6(0x211)]!==_0x11e4a6(0x12c)?_0x11e4a6(0x15b):'')+'\x22>'+_0x2247bf+_0x11e4a6(0x158)+_0x3a6814+_0x11e4a6(0x19c),_0x462c90[_0x11e4a6(0x136)](_0x105ead);}),showModal(_0x312761(0x121));};function _0x3840(_0x553b9d,_0x5f0a8e){const _0x5efaaf=_0x5efa();return _0x3840=function(_0x3840f1,_0x4e06f8){_0x3840f1=_0x3840f1-0xfb;let _0x376ef3=_0x5efaaf[_0x3840f1];return _0x376ef3;},_0x3840(_0x553b9d,_0x5f0a8e);}const displayRecords=_0x4c9950=>{const _0x532581=_0x4e3bf4,_0x52986e=document['getElementById'](_0x532581(0xfb)),_0x41cf65=document[_0x532581(0x21b)]('noResultsModal'),_0x11a40a=[_0x532581(0x1f4),'subadmin'][_0x532581(0xfd)](currentUser[_0x532581(0x19b)]);_0x52986e['innerHTML']='',document['getElementById'](_0x532581(0x120))[_0x532581(0x236)][_0x532581(0x147)]('hidden',!_0x11a40a),document[_0x532581(0x21b)](_0x532581(0x1ed))[_0x532581(0x236)][_0x532581(0x147)](_0x532581(0x272),!_0x11a40a),_0x4c9950[_0x532581(0x1fb)]((_0x35996a,_0x9e05b5)=>new Date(getLatestDispensing(_0x9e05b5)?.['dispensingDate']||0x0)-new Date(getLatestDispensing(_0x35996a)?.[_0x532581(0x1a1)]||0x0)),_0x41cf65['classList'][_0x532581(0x147)](_0x532581(0x272),_0x4c9950[_0x532581(0x1c3)]>0x0),_0x4c9950[_0x532581(0x1c3)]>0x0&&_0x4c9950['forEach'](_0x464c23=>{const _0x475e97=_0x532581,_0x6c605a=getLatestDispensing(_0x464c23),_0xd8cf4f=_0x6c605a?.[_0x475e97(0x211)]||_0x475e97(0x12c),_0x226c2a=_0xd8cf4f===_0x475e97(0x12c)?'<span\x20class=\x22text-gray-500\x22>لا\x20يوجد</span>':_0xd8cf4f,_0x429901=new Date(_0xd8cf4f)<new Date()&&_0xd8cf4f!==_0x475e97(0x12c)?_0x475e97(0x153):'text-green-600',_0x1f9910=(_0x464c23[_0x475e97(0x168)]||[])[_0x475e97(0x25f)](_0x82fa10=>_0x475e97(0x20d)+_0x82fa10+_0x475e97(0x218))[_0x475e97(0x209)](''),_0x4cf983=_0x11a40a?_0x475e97(0x1a2)+(PHARMACY_LIST[_0x464c23[_0x475e97(0x1bb)]]||_0x464c23[_0x475e97(0x1bb)])+_0x475e97(0x137):'',_0x445500=_0x11a40a?'<td\x20class=\x22px-6\x20py-4\x22>'+(_0x464c23[_0x475e97(0x266)]||_0x475e97(0x12c))[_0x475e97(0x1b5)]('@')[0x0]+_0x475e97(0x137):'',_0x183b36=document[_0x475e97(0x176)]('tr');_0x183b36[_0x475e97(0x106)]='bg-white\x20border-b\x20hover:bg-gray-50',_0x183b36['innerHTML']='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-6\x20py-4\x20font-bold\x22>'+_0x464c23[_0x475e97(0x257)]+_0x475e97(0x214)+_0x464c23[_0x475e97(0x25e)]+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-6\x20py-4\x22>'+(_0x464c23['phoneNumber']||_0x475e97(0x12c))+_0x475e97(0x1fe)+_0x4cf983+_0x475e97(0x270)+_0x464c23['prescriptionNumber']+_0x475e97(0x214)+_0x1f9910+_0x475e97(0x111)+(_0xd8cf4f===_0x475e97(0x12c)?'text-gray-500':_0x429901)+'\x22>'+_0x226c2a+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x445500+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-6\x20py-4\x20text-center\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20onclick=\x22showDispensingHistory(\x27'+_0x464c23['id']+_0x475e97(0x265)+_0x464c23[_0x475e97(0x1bb)]+_0x475e97(0x287)+_0x464c23['dispensingHistory'][_0x475e97(0x1c3)]+')</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20',_0x52986e['appendChild'](_0x183b36);}),showModal(_0x532581(0x17b));},renderCurrentMedications=(_0x5889b0=currentMedications)=>{const _0x4142b6=_0x4e3bf4,_0x42bcd9=document[_0x4142b6(0x21b)]('selectedMedicationsContainer');_0x5889b0[_0x4142b6(0x1c3)]===0x0?_0x42bcd9[_0x4142b6(0x217)]=_0x4142b6(0x178):_0x42bcd9[_0x4142b6(0x217)]=_0x5889b0[_0x4142b6(0x25f)]((_0x1e5a20,_0x59cbbd)=>_0x4142b6(0x18f)+_0x1e5a20+_0x4142b6(0x1d6)+_0x59cbbd+_0x4142b6(0x14c))[_0x4142b6(0x209)](''),document[_0x4142b6(0x21b)](_0x4142b6(0x103))[_0x4142b6(0x17f)]=_0x5889b0['length'];};window[_0x4e3bf4(0x1c5)]=_0x2b34bc=>{const _0x5ceff7=_0x4e3bf4;currentMedications[_0x5ceff7(0x10b)](_0x2b34bc,0x1),renderCurrentMedications();};const autofillPatientDataOnIdBlur=async()=>{const _0x58847b=_0x4e3bf4,_0x4f253b=document[_0x58847b(0x21b)](_0x58847b(0x25e)),_0x1374f4=document[_0x58847b(0x21b)](_0x58847b(0x257)),_0x41ac5a=document[_0x58847b(0x21b)](_0x58847b(0x285)),_0x43df08=_0x4f253b[_0x58847b(0x17f)][_0x58847b(0x160)]();if(!_0x43df08||_0x1374f4['value'][_0x58847b(0x160)]()!==''||_0x1374f4['disabled'])return;_0x4f253b[_0x58847b(0x236)][_0x58847b(0x184)](_0x58847b(0x262));try{const _0x1465b2=doc(db,'patients',_0x43df08),_0x2ca91c=await getDoc(_0x1465b2);if(_0x2ca91c['exists']()){const _0x416057=_0x2ca91c['data']();_0x1374f4[_0x58847b(0x17f)]=_0x416057[_0x58847b(0x257)]||'',_0x41ac5a[_0x58847b(0x17f)]=_0x416057[_0x58847b(0x285)]||'',showMessage(_0x58847b(0x1a0),'blue');return;}const _0x2e3cb2=collectionGroup(db,_0x58847b(0x104)),_0x136758=query(_0x2e3cb2,where(_0x58847b(0x25e),'==',_0x43df08)),_0xedb072=await getDocs(_0x136758);if(!_0xedb072[_0x58847b(0x15a)]){const _0x23db7a=_0xedb072[_0x58847b(0x157)][0x0][_0x58847b(0x117)]();_0x1374f4[_0x58847b(0x17f)]=_0x23db7a[_0x58847b(0x257)]||'',_0x41ac5a[_0x58847b(0x17f)]=_0x23db7a[_0x58847b(0x285)]||'',showMessage(_0x58847b(0x139),_0x58847b(0x102));}}catch(_0x2dbab3){console['error'](_0x58847b(0x11f),_0x2dbab3),showMessage(_0x58847b(0x109),_0x58847b(0x10f));}finally{_0x4f253b['classList'][_0x58847b(0x1a5)](_0x58847b(0x262));}},addMedication=_0x294fe6=>{const _0x1749a4=_0x4e3bf4,_0xa151d4=_0x294fe6[_0x1749a4(0x160)]();if(!_0xa151d4)return;!AVAILABLE_MEDICATIONS[_0x1749a4(0x22f)](_0x4e8ae8=>_0x4e8ae8[_0x1749a4(0x155)]()===_0xa151d4[_0x1749a4(0x155)]())&&(AVAILABLE_MEDICATIONS[_0x1749a4(0x1b8)](_0xa151d4),AVAILABLE_MEDICATIONS[_0x1749a4(0x1fb)]((_0x4d461b,_0x242ded)=>_0x4d461b['localeCompare'](_0x242ded,'ar')),addMedicationToFirestore(_0xa151d4));if(!currentMedications[_0x1749a4(0xfd)](_0xa151d4))currentMedications['push'](_0xa151d4);document[_0x1749a4(0x21b)](_0x1749a4(0x286))[_0x1749a4(0x17f)]='',renderCurrentMedications(),document['getElementById']('medicationSuggestions')[_0x1749a4(0x236)]['add'](_0x1749a4(0x272));},setupPharmacySearch=()=>{const _0x1801db=_0x4e3bf4,_0x3e7fbc=document[_0x1801db(0x21b)](_0x1801db(0x1f6)),_0x312bd7=document[_0x1801db(0x21b)](_0x1801db(0x1f8)),_0x282426=()=>{const _0x59d1fa=_0x1801db,_0x3019fc=_0x3e7fbc[_0x59d1fa(0x17f)][_0x59d1fa(0x160)]()[_0x59d1fa(0x155)]();_0x312bd7[_0x59d1fa(0x217)]='';const _0x522794=Object[_0x59d1fa(0x189)](PHARMACY_LIST)['filter'](([_0xf0e508,_0x623e80])=>_0xf0e508[_0x59d1fa(0xfd)](_0x3019fc)||_0x623e80['toLowerCase']()['includes'](_0x3019fc));_0x59d1fa(0x1a4)[_0x59d1fa(0xfd)](_0x3019fc)&&_0x522794[_0x59d1fa(0x250)]([_0x59d1fa(0x276),_0x59d1fa(0x240)]),_0x3019fc&&_0x522794['length']>0x0?(_0x312bd7[_0x59d1fa(0x236)][_0x59d1fa(0x1a5)]('hidden'),_0x522794[_0x59d1fa(0x22d)](([_0x451267,_0x5893e4])=>{const _0x17f1a8=_0x59d1fa,_0x677f5c=document['createElement'](_0x17f1a8(0x150));_0x677f5c['className']=_0x17f1a8(0x279),_0x677f5c[_0x17f1a8(0x186)]=_0x5893e4+'\x20('+_0x451267+')',_0x677f5c[_0x17f1a8(0x1c9)]=()=>{const _0x50820c=_0x17f1a8;_0x3e7fbc['value']=_0x451267,_0x312bd7[_0x50820c(0x236)][_0x50820c(0x184)](_0x50820c(0x272));},_0x312bd7[_0x17f1a8(0x136)](_0x677f5c);})):_0x312bd7['classList'][_0x59d1fa(0x184)](_0x59d1fa(0x272));};_0x3e7fbc[_0x1801db(0x237)](_0x1801db(0x12d),_0x282426),_0x3e7fbc[_0x1801db(0x237)](_0x1801db(0x25a),_0x282426),document[_0x1801db(0x237)](_0x1801db(0x228),_0x1846a1=>{const _0x50be5a=_0x1801db;!_0x1846a1['target']['closest'](_0x50be5a(0x113))&&_0x312bd7['classList'][_0x50be5a(0x184)](_0x50be5a(0x272));});},setupSearchableDropdown=()=>{const _0x1cf2ab=_0x4e3bf4,_0x134fe6=document[_0x1cf2ab(0x21b)](_0x1cf2ab(0x286)),_0x615eb1=document['getElementById'](_0x1cf2ab(0x12f)),_0x348b81=document[_0x1cf2ab(0x21b)](_0x1cf2ab(0x180)),_0x506edd=()=>{const _0x33678f=_0x1cf2ab,_0x1886ab=_0x134fe6[_0x33678f(0x17f)][_0x33678f(0x160)]()[_0x33678f(0x155)]();_0x615eb1[_0x33678f(0x217)]='';if(!_0x1886ab)return _0x615eb1[_0x33678f(0x236)][_0x33678f(0x184)](_0x33678f(0x272));const _0x1a7902=AVAILABLE_MEDICATIONS[_0x33678f(0x215)](_0x5185f0=>_0x5185f0[_0x33678f(0x155)]()[_0x33678f(0xfd)](_0x1886ab))[_0x33678f(0x166)](0x0,0xa);_0x615eb1['classList'][_0x33678f(0x147)](_0x33678f(0x272),_0x1a7902[_0x33678f(0x1c3)]===0x0),_0x1a7902['forEach'](_0x12974e=>{const _0x5aabcd=_0x33678f,_0x50d5a5=document[_0x5aabcd(0x176)](_0x5aabcd(0x150));_0x50d5a5['className']='px-4\x20py-2\x20hover:bg-gray-100\x20text-sm\x20flex\x20justify-between\x20items-center';const _0x4f216d=document['createElement'](_0x5aabcd(0x1c6));_0x4f216d['textContent']=_0x12974e,_0x4f216d[_0x5aabcd(0x106)]='flex-grow\x20cursor-pointer',_0x4f216d[_0x5aabcd(0x1c9)]=_0x3f9d9a=>{const _0x283531=_0x5aabcd;_0x3f9d9a[_0x283531(0x23a)](),addMedication(_0x12974e);};const _0x40b540=document[_0x5aabcd(0x176)]('button');_0x40b540['innerHTML']=_0x5aabcd(0x10a),_0x40b540[_0x5aabcd(0x106)]=_0x5aabcd(0x229),_0x40b540['type']='button',_0x40b540['onclick']=_0x345925=>{const _0x7d95a=_0x5aabcd;_0x345925[_0x7d95a(0x23a)](),window[_0x7d95a(0x1fa)](_0x12974e);},_0x50d5a5[_0x5aabcd(0x136)](_0x4f216d),_0x50d5a5[_0x5aabcd(0x136)](_0x40b540),_0x615eb1[_0x5aabcd(0x136)](_0x50d5a5);});};_0x134fe6[_0x1cf2ab(0x237)](_0x1cf2ab(0x12d),_0x506edd),_0x348b81[_0x1cf2ab(0x237)](_0x1cf2ab(0x228),()=>addMedication(_0x134fe6[_0x1cf2ab(0x17f)])),_0x134fe6[_0x1cf2ab(0x237)](_0x1cf2ab(0x27d),_0x5c2092=>{const _0x54a203=_0x1cf2ab;_0x5c2092[_0x54a203(0x18a)]===_0x54a203(0x148)&&(_0x5c2092['preventDefault'](),addMedication(_0x134fe6[_0x54a203(0x17f)]));}),document[_0x1cf2ab(0x237)](_0x1cf2ab(0x228),_0xd48751=>{const _0x345fa0=_0x1cf2ab;if(!_0xd48751[_0x345fa0(0x22a)][_0x345fa0(0x20c)](_0x345fa0(0x1e5)))_0x615eb1[_0x345fa0(0x236)]['add']('hidden');});},checkPrescription=async()=>{const _0x36854f=_0x4e3bf4,_0x22add6=document[_0x36854f(0x21b)](_0x36854f(0x135))[_0x36854f(0x17f)][_0x36854f(0x160)]();if(!_0x22add6)return;resetFormState(!![],_0x22add6);const _0x4c7d37=document[_0x36854f(0x21b)](_0x36854f(0x16b));_0x4c7d37[_0x36854f(0x129)]=!![],_0x4c7d37['innerHTML']=_0x36854f(0x141);let _0x29fe6c=null;try{const _0x50a677=collectionGroup(db,_0x36854f(0x104)),_0x472a29=query(_0x50a677,where(_0x36854f(0x135),'==',_0x22add6)),_0x1ae00d=await getDocs(_0x472a29);if(!_0x1ae00d[_0x36854f(0x15a)]){const _0x477d6a=_0x1ae00d[_0x36854f(0x157)][0x0],_0x11fd9b=_0x477d6a[_0x36854f(0x162)][_0x36854f(0x223)][_0x36854f(0x223)]['id'];_0x29fe6c={'id':_0x477d6a['id'],'pharmacyId':_0x11fd9b,..._0x477d6a[_0x36854f(0x117)]()};}if(_0x29fe6c){const _0x255273=getLatestDispensing(_0x29fe6c);if(_0x255273&&_0x255273[_0x36854f(0x14a)]===0x0){showMessage(_0x36854f(0x252),'red'),_0x4c7d37[_0x36854f(0x129)]=![],_0x4c7d37[_0x36854f(0x217)]=_0x36854f(0x27e);return;}currentRecord=_0x29fe6c,[_0x36854f(0x257),_0x36854f(0x25e),_0x36854f(0x285),_0x36854f(0x135)][_0x36854f(0x22d)](_0x2ba758=>{const _0x535bf2=_0x36854f,_0x490c89=document['getElementById'](_0x2ba758);_0x490c89[_0x535bf2(0x17f)]=currentRecord[_0x2ba758]||'',_0x490c89[_0x535bf2(0x129)]=!![];}),currentMedications=[...currentRecord[_0x36854f(0x168)]],renderCurrentMedications();const _0x7643eb=typeof PHARMACY_LIST!==_0x36854f(0x261)&&PHARMACY_LIST[_0x29fe6c[_0x36854f(0x1bb)]]?PHARMACY_LIST[_0x29fe6c[_0x36854f(0x1bb)]]:_0x29fe6c['pharmacyId']||_0x36854f(0x1e3);document['getElementById']('submitButton')[_0x36854f(0x186)]=_0x36854f(0x254),document[_0x36854f(0x21b)]('submitButton')[_0x36854f(0x106)]=_0x36854f(0x1b7);const _0x5190c4=['superadmin',_0x36854f(0x26f)]['includes'](currentUser[_0x36854f(0x19b)]);!_0x5190c4&&_0x29fe6c[_0x36854f(0x1bb)]!==currentUser[_0x36854f(0x1bb)]?showMessage(_0x36854f(0x15f)+_0x7643eb+_0x36854f(0x13c),'blue'):showMessage(_0x36854f(0x26c),_0x36854f(0x102)),_0x5190c4&&(document[_0x36854f(0x21b)](_0x36854f(0x11b))[_0x36854f(0x17f)]=_0x29fe6c[_0x36854f(0x1bb)]),document[_0x36854f(0x21b)](_0x36854f(0x1a1))['focus']();}else resetFormState(![],_0x22add6),showMessage(_0x36854f(0x20e),_0x36854f(0x1de));}catch(_0x2c9d71){console[_0x36854f(0x260)]('Error\x20checking\x20prescription:',_0x2c9d71),showMessage(_0x36854f(0x130)+_0x2c9d71[_0x36854f(0x108)],_0x36854f(0x10f));}finally{_0x4c7d37[_0x36854f(0x129)]=![],_0x4c7d37['textContent']=_0x36854f(0x27e);}},resetFormState=(_0x28d217=!![],_0x43c9fb='')=>{const _0x2928d0=_0x4e3bf4;currentRecord=null,[_0x2928d0(0x257),_0x2928d0(0x25e),_0x2928d0(0x285),_0x2928d0(0x135)]['forEach'](_0x50eabf=>{const _0x4dd90c=_0x2928d0,_0x18db7e=document[_0x4dd90c(0x21b)](_0x50eabf);_0x18db7e[_0x4dd90c(0x129)]=![];if(_0x28d217)_0x18db7e['value']='';});_0x28d217&&(currentMedications=[],document[_0x2928d0(0x21b)](_0x2928d0(0x286))['value']='',renderCurrentMedications());if([_0x2928d0(0x1f4),_0x2928d0(0x26f)][_0x2928d0(0xfd)](currentUser[_0x2928d0(0x19b)])){document[_0x2928d0(0x21b)](_0x2928d0(0x11b))['disabled']=![];if(_0x28d217)document['getElementById'](_0x2928d0(0x11b))['value']='';}document[_0x2928d0(0x21b)](_0x2928d0(0x14b))['textContent']=_0x2928d0(0x200),document['getElementById'](_0x2928d0(0x14b))[_0x2928d0(0x106)]=_0x2928d0(0x251),document[_0x2928d0(0x21b)](_0x2928d0(0x135))[_0x2928d0(0x17f)]=_0x43c9fb||(_0x28d217?'':''),document[_0x2928d0(0x21b)](_0x2928d0(0x1a1))[_0x2928d0(0x17f)]='',document['getElementById'](_0x2928d0(0x24b))[_0x2928d0(0x17f)]='';if(_0x28d217)document[_0x2928d0(0x21b)](_0x2928d0(0x1f5))[_0x2928d0(0x236)][_0x2928d0(0x184)](_0x2928d0(0x272));calculateRefillDate();},calculateRefillDate=()=>{const _0x58093e=_0x4e3bf4,_0x1cfcf7=document[_0x58093e(0x21b)]('dispensingDate')[_0x58093e(0x17f)],_0x55b796=document['getElementById'](_0x58093e(0x24b))[_0x58093e(0x17f)],_0x4a09fd=document[_0x58093e(0x21b)](_0x58093e(0x211)),_0x347b2d=document[_0x58093e(0x21b)]('refillDateDisplay');if(!_0x1cfcf7||_0x55b796===''){_0x4a09fd[_0x58093e(0x17f)]='',_0x347b2d[_0x58093e(0x186)]=_0x58093e(0x11c);return;}if(_0x55b796==='0'){_0x4a09fd[_0x58093e(0x17f)]=_0x58093e(0x12c),_0x347b2d[_0x58093e(0x186)]='لا\x20يوجد\x20إعادة\x20صرف';return;}const _0x990b0f=new Date(_0x1cfcf7);_0x990b0f[_0x58093e(0x238)](_0x990b0f[_0x58093e(0x18d)]()+parseInt(_0x55b796,0xa));const _0x3900a6=formatDate(_0x990b0f);_0x4a09fd[_0x58093e(0x17f)]=_0x3900a6,_0x347b2d['textContent']=_0x3900a6;},filterRecords=async()=>{const _0x263d7c=_0x4e3bf4,_0x1ad2a2=document['getElementById'](_0x263d7c(0x267));_0x1ad2a2[_0x263d7c(0x129)]=!![],_0x1ad2a2[_0x263d7c(0x217)]=_0x263d7c(0x141);let _0x2b9a71=['superadmin',_0x263d7c(0x26f)][_0x263d7c(0xfd)](currentUser[_0x263d7c(0x19b)])?await getRecordsForCurrentUserScope():records;if(_0x2b9a71===null){_0x1ad2a2[_0x263d7c(0x129)]=![],_0x1ad2a2[_0x263d7c(0x186)]=_0x263d7c(0x259);return;}const _0x437428=document[_0x263d7c(0x21b)](_0x263d7c(0x1be))[_0x263d7c(0x17f)],_0x44c7f6=document[_0x263d7c(0x21b)](_0x263d7c(0x182))[_0x263d7c(0x17f)],_0x4b99f4=document[_0x263d7c(0x21b)](_0x263d7c(0x21d))[_0x263d7c(0x17f)]['trim']()['toLowerCase'](),_0xeaaabb=document[_0x263d7c(0x21b)](_0x263d7c(0x206))['value'][_0x263d7c(0x160)]()[_0x263d7c(0x155)]();if(_0x437428&&_0x44c7f6&&_0x437428>_0x44c7f6){showMessage(_0x263d7c(0x23b),'red'),_0x1ad2a2['disabled']=![],_0x1ad2a2[_0x263d7c(0x186)]=_0x263d7c(0x259);return;}const _0x6b93b8=_0x2b9a71['filter'](_0x9d1d1c=>{const _0x13322a=_0x263d7c,_0x40a8e1=getLatestDispensing(_0x9d1d1c);if(!_0x40a8e1)return![];if(_0x437428&&(_0x40a8e1['refillDate']<_0x437428||_0x40a8e1[_0x13322a(0x211)]==='N/A'))return![];if(_0x44c7f6&&(_0x40a8e1['refillDate']>_0x44c7f6||_0x40a8e1[_0x13322a(0x211)]===_0x13322a(0x12c)))return![];if(_0x4b99f4&&!(_0x9d1d1c[_0x13322a(0x168)]||[])['some'](_0x1d1fcd=>_0x1d1fcd[_0x13322a(0x155)]()[_0x13322a(0xfd)](_0x4b99f4)))return![];if(_0xeaaabb&&!(_0x9d1d1c['idNumber']?.[_0x13322a(0x155)]()[_0x13322a(0xfd)](_0xeaaabb)||_0x9d1d1c[_0x13322a(0x257)]?.['toLowerCase']()[_0x13322a(0xfd)](_0xeaaabb)||_0x9d1d1c['phoneNumber']?.[_0x13322a(0xfd)](_0xeaaabb)||_0x9d1d1c[_0x13322a(0x135)]?.['toLowerCase']()['includes'](_0xeaaabb)))return![];return!![];});_0x1ad2a2[_0x263d7c(0x129)]=![],_0x1ad2a2[_0x263d7c(0x186)]='بحث',displayRecords(_0x6b93b8);},clearSearch=()=>{const _0x5aef05=_0x4e3bf4;['startDateFilter',_0x5aef05(0x182),_0x5aef05(0x21d),_0x5aef05(0x206)][_0x5aef05(0x22d)](_0x5542b8=>document[_0x5aef05(0x21b)](_0x5542b8)[_0x5aef05(0x17f)]=''),closeModal('resultsModal');},handleFormSubmit=async _0x186487=>{const _0x3ba8ce=_0x4e3bf4;_0x186487[_0x3ba8ce(0x159)]();const _0x1ef75a=_0x186487[_0x3ba8ce(0x22a)],{prescriptionNumber:_0x128fbf,dispensingDate:_0x27136d,refillDuration:_0x1a52f8,medicationCount:_0x510a72,patientName:_0x22cbf2,idNumber:_0x29f379,phoneNumber:_0x2cfa54}=_0x1ef75a[_0x3ba8ce(0x131)],_0x30ecb6=[_0x3ba8ce(0x1f4),'subadmin'][_0x3ba8ce(0xfd)](currentUser[_0x3ba8ce(0x19b)]);let _0x472940;_0x30ecb6?_0x472940=_0x1ef75a[_0x3ba8ce(0x131)][_0x3ba8ce(0x11b)]['value']:_0x472940=currentUser[_0x3ba8ce(0x1bb)];currentRecord&&_0x30ecb6&&!_0x472940&&(_0x472940=currentRecord['pharmacyId']);if(_0x30ecb6&&!_0x472940)return showMessage(_0x3ba8ce(0x112),_0x3ba8ce(0x10f));if(!_0x128fbf[_0x3ba8ce(0x17f)]['trim']())return showMessage('يرجى\x20إدخال\x20رقم\x20الوصفة.','yellow');if(!_0x22cbf2[_0x3ba8ce(0x17f)][_0x3ba8ce(0x160)]())return showMessage(_0x3ba8ce(0x172),_0x3ba8ce(0x1de));if(!_0x29f379[_0x3ba8ce(0x17f)][_0x3ba8ce(0x160)]())return showMessage(_0x3ba8ce(0x144),_0x3ba8ce(0x1de));if(parseInt(_0x510a72['value'],0xa)===0x0)return showMessage(_0x3ba8ce(0x15c),_0x3ba8ce(0x1de));if(!_0x27136d[_0x3ba8ce(0x17f)])return showMessage(_0x3ba8ce(0x204),_0x3ba8ce(0x1de));if(_0x1a52f8[_0x3ba8ce(0x17f)]==='')return showMessage(_0x3ba8ce(0x167),_0x3ba8ce(0x1de));if(!currentRecord){const _0x367452=_0x2cfa54[_0x3ba8ce(0x17f)][_0x3ba8ce(0x160)]();if(!_0x367452||!/^\d{10}$/[_0x3ba8ce(0x22e)](_0x367452))return showMessage('رقم\x20الهاتف\x20يجب\x20أن\x20يتكون\x20من\x2010\x20أرقام.',_0x3ba8ce(0x1de));}const _0x886527=document[_0x3ba8ce(0x21b)](_0x3ba8ce(0x14b));_0x886527[_0x3ba8ce(0x129)]=!![],_0x886527[_0x3ba8ce(0x217)]='<div\x20class=\x22loader\x20mx-auto\x22></div>';try{const _0x2754a1={'dispensingID':crypto['randomUUID'](),'dispensingDate':_0x1ef75a[_0x3ba8ce(0x131)][_0x3ba8ce(0x1a1)][_0x3ba8ce(0x17f)],'refillDate':_0x1ef75a[_0x3ba8ce(0x131)][_0x3ba8ce(0x211)][_0x3ba8ce(0x17f)],'durationDays':parseInt(_0x1a52f8['value'],0xa),'transactionTime':new Date()[_0x3ba8ce(0x13a)](),'medications':[...currentMedications],'dispensedBy':auth['currentUser']['email']};if(currentRecord&&_0x30ecb6&&_0x472940!==currentRecord[_0x3ba8ce(0x1bb)]){const _0x376161={...currentRecord,'medications':[...currentMedications],'dispensingHistory':[...currentRecord[_0x3ba8ce(0x1ef)],_0x2754a1]};delete _0x376161['id'],delete _0x376161['pharmacyId'];const _0x3bbfad=doc(db,_0x3ba8ce(0x1b6)+currentRecord[_0x3ba8ce(0x1bb)]+'/records',currentRecord['id']),_0x409b7f=doc(collection(db,_0x3ba8ce(0x1b6)+_0x472940+_0x3ba8ce(0x1d8))),_0x226ca3=writeBatch(db);_0x226ca3['set'](_0x409b7f,_0x376161),_0x226ca3[_0x3ba8ce(0x1da)](_0x3bbfad),await _0x226ca3['commit'](),showMessage(_0x3ba8ce(0x132),_0x3ba8ce(0x1ad));}else{if(currentRecord){const _0x2104e6=doc(db,'pharmacies/'+currentRecord[_0x3ba8ce(0x1bb)]+_0x3ba8ce(0x1d8),currentRecord['id']);await updateDoc(_0x2104e6,{'medications':[...currentMedications],'dispensingHistory':[...currentRecord['dispensingHistory'],_0x2754a1]}),showMessage(_0x3ba8ce(0x1a6),'green');}else{const _0x29aff6=doc(db,'patients',_0x29f379['value']['trim']());await setDoc(_0x29aff6,{'patientName':_0x22cbf2[_0x3ba8ce(0x17f)][_0x3ba8ce(0x160)](),'phoneNumber':_0x2cfa54[_0x3ba8ce(0x17f)][_0x3ba8ce(0x160)](),'createdAt':new Date()[_0x3ba8ce(0x13a)](),'createdBy':auth[_0x3ba8ce(0x26d)][_0x3ba8ce(0x1d4)]},{'merge':!![]}),await addDoc(collection(db,_0x3ba8ce(0x1b6)+_0x472940+'/records'),{'patientName':_0x22cbf2[_0x3ba8ce(0x17f)][_0x3ba8ce(0x160)](),'idNumber':_0x29f379[_0x3ba8ce(0x17f)][_0x3ba8ce(0x160)](),'phoneNumber':_0x2cfa54[_0x3ba8ce(0x17f)][_0x3ba8ce(0x160)](),'prescriptionNumber':_0x128fbf['value'][_0x3ba8ce(0x160)](),'medications':[...currentMedications],'dispensingHistory':[_0x2754a1],'createdAt':new Date()[_0x3ba8ce(0x13a)](),'createdBy':auth['currentUser']['email']}),showMessage(_0x3ba8ce(0x281),'green');}}_0x30ecb6&&(isDataFetchedForAdmin=![],sessionStorage['removeItem']('adminDataCache')),resetFormState(!![]);}catch(_0x1eeddb){console[_0x3ba8ce(0x260)](_0x3ba8ce(0x1a3),_0x1eeddb),showMessage(_0x3ba8ce(0x123)+_0x1eeddb[_0x3ba8ce(0x108)],_0x3ba8ce(0x10f));}finally{_0x886527[_0x3ba8ce(0x129)]=![],_0x886527[_0x3ba8ce(0x186)]=_0x3ba8ce(0x200);}},convertExcelDate=_0x5978cc=>{const _0x4776fc=_0x4e3bf4;if(typeof _0x5978cc==='number')return new Date((_0x5978cc-0x63e1)*0x15180*0x3e8);if(typeof _0x5978cc===_0x4776fc(0x1dc)){const _0x18ae9a=new Date(_0x5978cc);if(!isNaN(_0x18ae9a['getTime']()))return _0x18ae9a;}return null;},findExistingPrescriptionsInBulk=async _0x4a2c79=>{const _0x1a5b57=_0x4e3bf4,_0x1e6ff8=new Set();if(_0x4a2c79[_0x1a5b57(0x1c3)]===0x0)return _0x1e6ff8;const _0x459b69=[];for(let _0x52e7b7=0x0;_0x52e7b7<_0x4a2c79[_0x1a5b57(0x1c3)];_0x52e7b7+=0x1e){_0x459b69['push'](_0x4a2c79[_0x1a5b57(0x166)](_0x52e7b7,_0x52e7b7+0x1e));}const _0x2f63f3=collectionGroup(db,_0x1a5b57(0x104));for(const _0x4fbcb2 of _0x459b69){const _0xec72ca=query(_0x2f63f3,where('prescriptionNumber','in',_0x4fbcb2)),_0x939696=await getDocs(_0xec72ca);_0x939696[_0x1a5b57(0x22d)](_0x207134=>{const _0x529eb0=_0x1a5b57;_0x1e6ff8[_0x529eb0(0x184)](_0x207134[_0x529eb0(0x117)]()['prescriptionNumber']);});}return _0x1e6ff8;},handleFileSelection=_0x5359f6=>{const _0x5dc62f=_0x4e3bf4,_0x5380ea=_0x5359f6['target'][_0x5dc62f(0x256)][0x0],_0x42caf9=document['getElementById']('fileNameDisplay');_0x5380ea?(selectedFileForImport=_0x5380ea,_0x42caf9[_0x5dc62f(0x186)]=_0x5380ea['name']):(selectedFileForImport=null,_0x42caf9[_0x5dc62f(0x186)]=_0x5dc62f(0x1f1));},handleImportProcess=()=>{const _0x2d6034=_0x4e3bf4,_0x522d79=document['getElementById'](_0x2d6034(0x134)),_0x2c8152=document['getElementById'](_0x2d6034(0x1ce)),_0x29368d=document[_0x2d6034(0x21b)](_0x2d6034(0x12e));if(!selectedFileForImport)return showMessage(_0x2d6034(0x199),_0x2d6034(0x1de));const _0x4e6be0=document[_0x2d6034(0x21b)](_0x2d6034(0x11b))[_0x2d6034(0x17f)];if(!_0x4e6be0)return _0x2c8152[_0x2d6034(0x17f)]='',_0x29368d[_0x2d6034(0x186)]=_0x2d6034(0x1f1),selectedFileForImport=null,showMessage(_0x2d6034(0x198),_0x2d6034(0x10f));_0x522d79['disabled']=!![],_0x522d79[_0x2d6034(0x217)]=_0x2d6034(0x205);const _0xa12119=new FileReader();_0xa12119[_0x2d6034(0x24c)]=async _0x1ec7f8=>{const _0x16aa08=_0x2d6034;try{const _0x1ae542=new Uint8Array(_0x1ec7f8['target'][_0x16aa08(0x1c4)]),_0x2d4596=XLSX[_0x16aa08(0x11e)](_0x1ae542,{'type':'array'}),_0x4aed65=XLSX['utils'][_0x16aa08(0x171)](_0x2d4596[_0x16aa08(0x227)][_0x2d4596[_0x16aa08(0x1af)][0x0]]);if(_0x4aed65['length']===0x0)throw new Error(_0x16aa08(0x16f));const _0x5cde74=writeBatch(db);let _0x524a3b=0x0,_0x4f8ace=0x0;const _0x4fb677=_0x4aed65[_0x16aa08(0x25f)](_0x3d1032=>String(_0x3d1032[_0x16aa08(0x17c)]||'')[_0x16aa08(0x160)]())[_0x16aa08(0x215)](_0x2e22fe=>_0x2e22fe),_0x118791=await findExistingPrescriptionsInBulk(_0x4fb677);for(const _0x2506c2 of _0x4aed65){const _0x4c1757=String(_0x2506c2[_0x16aa08(0x17c)]||'')[_0x16aa08(0x160)]();if(!_0x2506c2[_0x16aa08(0x133)]||!_0x2506c2[_0x16aa08(0x220)]||!_0x2506c2[_0x16aa08(0x232)]||!_0x4c1757||!_0x2506c2[_0x16aa08(0x1e0)]||!String(_0x2506c2[_0x16aa08(0x221)])||!_0x2506c2[_0x16aa08(0x1d2)]){_0x4f8ace++;continue;}if(_0x118791[_0x16aa08(0x27c)](_0x4c1757)){_0x4f8ace++;continue;}const _0x1180c7=convertExcelDate(_0x2506c2[_0x16aa08(0x1e0)]);if(!_0x1180c7){_0x4f8ace++;continue;}let _0x9b294=_0x16aa08(0x12c);const _0x1a26fb=parseInt(_0x2506c2['RefillDuration'],0xa);if(!isNaN(_0x1a26fb)&&_0x1a26fb>0x0){const _0xdcf775=new Date(_0x1180c7);_0xdcf775['setDate'](_0xdcf775[_0x16aa08(0x18d)]()+_0x1a26fb),_0x9b294=formatDate(_0xdcf775);}const _0xdd1666={'patientName':String(_0x2506c2['PatientName'])['trim'](),'idNumber':String(_0x2506c2[_0x16aa08(0x220)])[_0x16aa08(0x160)](),'phoneNumber':String(_0x2506c2[_0x16aa08(0x232)])[_0x16aa08(0x160)](),'prescriptionNumber':_0x4c1757,'medications':String(_0x2506c2[_0x16aa08(0x1d2)])[_0x16aa08(0x1b5)](',')[_0x16aa08(0x25f)](_0x53904c=>_0x53904c[_0x16aa08(0x160)]()),'createdAt':new Date()[_0x16aa08(0x13a)](),'createdBy':auth[_0x16aa08(0x26d)][_0x16aa08(0x1d4)],'dispensingHistory':[{'dispensingID':crypto['randomUUID'](),'dispensingDate':formatDate(_0x1180c7),'refillDate':_0x9b294,'durationDays':isNaN(_0x1a26fb)?0x0:_0x1a26fb,'transactionTime':new Date()['toISOString'](),'medications':String(_0x2506c2[_0x16aa08(0x1d2)])[_0x16aa08(0x1b5)](',')['map'](_0xbdaf0b=>_0xbdaf0b['trim']()),'dispensedBy':auth[_0x16aa08(0x26d)][_0x16aa08(0x1d4)]}]};_0x5cde74[_0x16aa08(0x1b0)](doc(collection(db,'pharmacies/'+_0x4e6be0+_0x16aa08(0x1d8))),_0xdd1666),_0x524a3b++,_0x118791[_0x16aa08(0x184)](_0x4c1757);}let _0x5ef0a3='';_0x524a3b>0x0&&(await _0x5cde74[_0x16aa08(0x249)](),_0x5ef0a3+=_0x16aa08(0x21f)+_0x524a3b+'\x20سجل\x20بنجاح!\x20',isDataFetchedForAdmin=![],sessionStorage[_0x16aa08(0x183)]('adminDataCache')),_0x4f8ace>0x0&&(_0x5ef0a3+=_0x16aa08(0x231)+_0x4f8ace+_0x16aa08(0x201)),_0x5ef0a3?showMessage(_0x5ef0a3[_0x16aa08(0x160)](),_0x524a3b>0x0?_0x16aa08(0x1ad):_0x16aa08(0x1de)):showMessage(_0x16aa08(0x212),_0x16aa08(0x1de));}catch(_0x11e2c0){console[_0x16aa08(0x260)](_0x16aa08(0x124),_0x11e2c0),showMessage(_0x16aa08(0x1ac)+_0x11e2c0['message'],_0x16aa08(0x10f));}finally{_0x522d79['disabled']=![],_0x522d79['textContent']=_0x16aa08(0x203),_0x2c8152[_0x16aa08(0x17f)]='',_0x29368d[_0x16aa08(0x186)]=_0x16aa08(0x1f1),selectedFileForImport=null;}},_0xa12119[_0x2d6034(0x140)](selectedFileForImport);},exportTableToExcel=(_0x4831c5,_0x3ea332=_0x4e3bf4(0x27b))=>{const _0x417c42=_0x4e3bf4,_0xfa33f8=document[_0x417c42(0x21b)](_0x4831c5);if(!_0xfa33f8)return showMessage(_0x417c42(0x1f9),_0x417c42(0x10f));XLSX[_0x417c42(0x152)](XLSX[_0x417c42(0x115)]['table_to_book'](_0xfa33f8,{'sheet':_0x417c42(0x202)}),_0x3ea332);},populateUserReportSelector=async()=>{const _0x594937=_0x4e3bf4,_0x57680f=document[_0x594937(0x21b)](_0x594937(0x216));_0x57680f[_0x594937(0x217)]=_0x594937(0x15d);try{const _0xf6f2dc=await getRecordsForCurrentUserScope();if(!_0xf6f2dc)return;const _0x30ce84=new Set();_0xf6f2dc[_0x594937(0x22d)](_0x3821b9=>{const _0x323727=_0x594937;if(_0x3821b9[_0x323727(0x266)])_0x30ce84[_0x323727(0x184)](_0x3821b9[_0x323727(0x266)]);if(_0x3821b9[_0x323727(0x1ef)])_0x3821b9[_0x323727(0x1ef)][_0x323727(0x22d)](_0x38e6f1=>{const _0x4c87c2=_0x323727;if(_0x38e6f1&&_0x38e6f1[_0x4c87c2(0x27a)])_0x30ce84[_0x4c87c2(0x184)](_0x38e6f1[_0x4c87c2(0x27a)]);});}),_0x30ce84['forEach'](_0x4af4b2=>{const _0x2c8d80=_0x594937,_0x11d71b=document['createElement'](_0x2c8d80(0x23d));_0x11d71b['value']=_0x4af4b2,_0x11d71b[_0x2c8d80(0x186)]=_0x4af4b2[_0x2c8d80(0x1b5)]('@')[0x0],_0x57680f[_0x2c8d80(0x136)](_0x11d71b);});}catch(_0xe43e10){console[_0x594937(0x260)](_0x594937(0x235),_0xe43e10),showMessage(_0x594937(0x234),_0x594937(0x10f));}},showUserDispensingReport=async()=>{const _0x305c77=_0x4e3bf4,_0xf83a22=document[_0x305c77(0x21b)](_0x305c77(0x1db));_0xf83a22['disabled']=!![],_0xf83a22['innerHTML']=_0x305c77(0x141);const _0x539563=document[_0x305c77(0x21b)]('userReportStartDate')['value'],_0x3efe93=document[_0x305c77(0x21b)](_0x305c77(0x271))[_0x305c77(0x17f)],_0x4cdd67=[_0x305c77(0x1f4),'subadmin'][_0x305c77(0xfd)](currentUser['role']);let _0x43402d=_0x4cdd67?document[_0x305c77(0x21b)](_0x305c77(0x216))[_0x305c77(0x17f)]:auth[_0x305c77(0x26d)]?.[_0x305c77(0x1d4)];try{if(_0x539563&&_0x3efe93&&_0x539563>_0x3efe93)throw new Error(_0x305c77(0x19a));let _0x13d830=_0x4cdd67?await getRecordsForCurrentUserScope():records;if(_0x13d830===null)throw new Error(_0x305c77(0x1f0));const _0x26e9e1=[];_0x13d830[_0x305c77(0x22d)](_0x488dae=>{const _0x373331=_0x305c77;_0x488dae['dispensingHistory']&&Array[_0x373331(0x288)](_0x488dae[_0x373331(0x1ef)])&&_0x488dae['dispensingHistory'][_0x373331(0x22d)](_0x4a9556=>{const _0x3a4b79=_0x373331;if(!_0x4a9556)return;const _0x48bb03=_0x4a9556[_0x3a4b79(0x27a)]||_0x488dae[_0x3a4b79(0x266)],_0x105e5e=(!_0x539563||_0x4a9556[_0x3a4b79(0x1a1)]>=_0x539563)&&(!_0x3efe93||_0x4a9556['dispensingDate']<=_0x3efe93),_0xff51d8=!_0x43402d||_0x48bb03===_0x43402d;_0x105e5e&&_0xff51d8&&_0x26e9e1[_0x3a4b79(0x1b8)]({..._0x4a9556,'patientName':_0x488dae[_0x3a4b79(0x257)],'phoneNumber':_0x488dae['phoneNumber'],'prescriptionNumber':_0x488dae[_0x3a4b79(0x135)],'pharmacyId':_0x488dae[_0x3a4b79(0x1bb)],'dispensedBy':_0x48bb03});});}),_0x26e9e1['sort']((_0x31d444,_0x19e80b)=>new Date(_0x19e80b[_0x305c77(0x1a1)])-new Date(_0x31d444[_0x305c77(0x1a1)])),document[_0x305c77(0x21b)](_0x305c77(0x1b2))[_0x305c77(0x217)]='';const _0x1a0b37=_0x43402d?_0x43402d['split']('@')[0x0]:_0x305c77(0x154);document[_0x305c77(0x21b)](_0x305c77(0x1c2))[_0x305c77(0x186)]=_0x305c77(0x1d0)+_0x1a0b37+_0x305c77(0x22c)+(_0x539563&&_0x3efe93?_0x305c77(0x10e)+_0x539563+'\x20إلى\x20'+_0x3efe93:_0x305c77(0x110)),document[_0x305c77(0x21b)](_0x305c77(0x27f))[_0x305c77(0x186)]=_0x305c77(0x213)+_0x26e9e1[_0x305c77(0x1c3)],document[_0x305c77(0x21b)](_0x305c77(0x1bd))[_0x305c77(0x236)][_0x305c77(0x147)]('hidden',_0x26e9e1[_0x305c77(0x1c3)]>0x0);const _0x574f84=_0x4cdd67&&!_0x43402d;document['getElementById'](_0x305c77(0x1c0))['classList'][_0x305c77(0x147)](_0x305c77(0x272),!_0x574f84),_0x26e9e1[_0x305c77(0x22d)](_0xd25d0f=>{const _0x464e6a=_0x305c77,_0x2f30c4=_0x574f84?_0x464e6a(0x226)+(_0xd25d0f[_0x464e6a(0x27a)]||_0x464e6a(0x12c))[_0x464e6a(0x1b5)]('@')[0x0]+'</td>':'',_0x23ed44=document[_0x464e6a(0x176)]('tr');_0x23ed44[_0x464e6a(0x106)]=_0x464e6a(0x24d),_0x23ed44[_0x464e6a(0x217)]=_0x464e6a(0x1eb)+_0xd25d0f[_0x464e6a(0x1a1)]+_0x464e6a(0x26e)+_0xd25d0f[_0x464e6a(0x257)]+_0x464e6a(0x26e)+(_0xd25d0f['phoneNumber']||'N/A')+_0x464e6a(0x26e)+_0xd25d0f[_0x464e6a(0x135)]+_0x464e6a(0x1fe)+_0x2f30c4+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x22>'+(PHARMACY_LIST[_0xd25d0f[_0x464e6a(0x1bb)]]||_0xd25d0f[_0x464e6a(0x1bb)])+_0x464e6a(0x26e)+(_0xd25d0f['medications']||[])[_0x464e6a(0x209)](',\x20')+_0x464e6a(0x137),document[_0x464e6a(0x21b)](_0x464e6a(0x1b2))[_0x464e6a(0x136)](_0x23ed44);}),document[_0x305c77(0x21b)](_0x305c77(0x222))[_0x305c77(0x236)][_0x305c77(0x147)](_0x305c77(0x272),!_0x4cdd67),showModal('userReportModal');}catch(_0x39570d){console[_0x305c77(0x260)](_0x305c77(0x169),_0x39570d);if(_0x39570d[_0x305c77(0x108)]==='Invalid\x20date\x20range.')showMessage(_0x305c77(0x23b),_0x305c77(0x10f));else showMessage(_0x305c77(0x244),_0x305c77(0x10f));}finally{_0xf83a22[_0x305c77(0x129)]=![],_0xf83a22[_0x305c77(0x186)]=_0x4cdd67?_0x305c77(0x245):_0x305c77(0x107);}},showUserSummaryReport=async()=>{const _0xd1b6db=_0x4e3bf4,_0x30fd49=document[_0xd1b6db(0x21b)](_0xd1b6db(0x170));_0x30fd49[_0xd1b6db(0x129)]=!![],_0x30fd49[_0xd1b6db(0x217)]=_0xd1b6db(0x141);const _0x151407=document[_0xd1b6db(0x21b)](_0xd1b6db(0x1e1))['value'],_0x12ffd0=document['getElementById'](_0xd1b6db(0x18c))[_0xd1b6db(0x17f)];try{if(_0x151407&&_0x12ffd0&&_0x151407>_0x12ffd0)throw new Error(_0xd1b6db(0x19a));let _0x620ab7=await getRecordsForCurrentUserScope();if(_0x620ab7===null)throw new Error(_0xd1b6db(0x1f0));const _0xa32eae={};_0x620ab7[_0xd1b6db(0x22d)](_0x35261c=>{const _0x2d7a56=_0xd1b6db;_0x35261c[_0x2d7a56(0x1ef)]&&Array[_0x2d7a56(0x288)](_0x35261c[_0x2d7a56(0x1ef)])&&_0x35261c['dispensingHistory'][_0x2d7a56(0x22d)](_0x28d608=>{const _0xa62af6=_0x2d7a56;if(!_0x28d608||!_0x28d608['dispensingDate'])return;const _0x42b808=_0x28d608['dispensedBy']||_0x35261c['createdBy'];if(_0x42b808&&(!_0x151407||_0x28d608[_0xa62af6(0x1a1)]>=_0x151407)&&(!_0x12ffd0||_0x28d608[_0xa62af6(0x1a1)]<=_0x12ffd0)){const _0xc86114=_0x42b808+':'+_0x28d608[_0xa62af6(0x1a1)]+':'+_0x35261c[_0xa62af6(0x1bb)];_0xa32eae[_0xc86114]=(_0xa32eae[_0xc86114]||0x0)+0x1;}});});const _0x3fd8c7=Object[_0xd1b6db(0x1ae)](_0xa32eae)[_0xd1b6db(0x25f)](_0x282733=>{const _0x107fe6=_0xd1b6db,[_0x528f5b,_0x2fc240,_0x1e8158]=_0x282733[_0x107fe6(0x1b5)](':');return{'userName':_0x528f5b['split']('@')[0x0],'date':_0x2fc240,'pharmacyId':_0x1e8158,'count':_0xa32eae[_0x282733]};})[_0xd1b6db(0x1fb)]((_0x1a5b78,_0x14354a)=>_0x14354a[_0xd1b6db(0x1f3)][_0xd1b6db(0x239)](_0x1a5b78[_0xd1b6db(0x1f3)])||_0x1a5b78[_0xd1b6db(0x1a9)][_0xd1b6db(0x239)](_0x14354a['userName'])),_0x3e7617=document[_0xd1b6db(0x21b)](_0xd1b6db(0x105));_0x3e7617['innerHTML']='',document[_0xd1b6db(0x21b)](_0xd1b6db(0x1e7))[_0xd1b6db(0x186)]=_0xd1b6db(0x18e)+_0x151407+'\x20إلى\x20'+_0x12ffd0;const _0x2d8a2e=_0x3fd8c7[_0xd1b6db(0x1cb)]((_0x2c9571,_0x5bf278)=>_0x2c9571+_0x5bf278['count'],0x0);document['getElementById'](_0xd1b6db(0x20a))[_0xd1b6db(0x186)]=_0xd1b6db(0x213)+_0x2d8a2e,document[_0xd1b6db(0x21b)](_0xd1b6db(0x13f))[_0xd1b6db(0x236)][_0xd1b6db(0x147)](_0xd1b6db(0x272),_0x3fd8c7[_0xd1b6db(0x1c3)]>0x0),_0x3fd8c7[_0xd1b6db(0x22d)](_0x5725ff=>{const _0xbbb89=_0xd1b6db,_0x3f9ce5=document[_0xbbb89(0x176)]('tr');_0x3f9ce5[_0xbbb89(0x106)]=_0xbbb89(0x24d),_0x3f9ce5[_0xbbb89(0x217)]='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20font-semibold\x22>'+_0x5725ff['userName']+_0xbbb89(0x26e)+_0x5725ff[_0xbbb89(0x1f3)]+_0xbbb89(0x26e)+(PHARMACY_LIST[_0x5725ff[_0xbbb89(0x1bb)]]||_0x5725ff[_0xbbb89(0x1bb)])+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x20font-bold\x20text-center\x20text-blue-700\x22>'+_0x5725ff[_0xbbb89(0x100)]+_0xbbb89(0x137),_0x3e7617[_0xbbb89(0x136)](_0x3f9ce5);}),showModal(_0xd1b6db(0x127));}catch(_0x5cb5f4){console[_0xd1b6db(0x260)]('User\x20summary\x20report\x20error:',_0x5cb5f4);if(_0x5cb5f4['message']===_0xd1b6db(0x19a))showMessage('تاريخ\x20البداية\x20يجب\x20أن\x20يكون\x20قبل\x20تاريخ\x20النهاية.',_0xd1b6db(0x10f));else showMessage(_0xd1b6db(0x244),'red');}finally{_0x30fd49[_0xd1b6db(0x129)]=![],_0x30fd49[_0xd1b6db(0x186)]=_0xd1b6db(0x245);}},showNoRefillReport=async()=>{const _0x2404ab=_0x4e3bf4,_0x374ef0=document[_0x2404ab(0x21b)](_0x2404ab(0x1ec));_0x374ef0['disabled']=!![],_0x374ef0[_0x2404ab(0x217)]=_0x2404ab(0x141);const _0x1c7f46=['superadmin','subadmin'][_0x2404ab(0xfd)](currentUser['role']);try{let _0x46701b=_0x1c7f46?await getRecordsForCurrentUserScope():records;if(_0x46701b===null)throw new Error(_0x2404ab(0x264));const _0x46c750=_0x46701b[_0x2404ab(0x215)](_0x4b1958=>getLatestDispensing(_0x4b1958)?.[_0x2404ab(0x14a)]===0x0),_0x2797b2=document[_0x2404ab(0x21b)](_0x2404ab(0xfe));_0x2797b2[_0x2404ab(0x217)]='',document[_0x2404ab(0x21b)]('noResultsReport')[_0x2404ab(0x236)][_0x2404ab(0x147)](_0x2404ab(0x272),_0x46c750[_0x2404ab(0x1c3)]>0x0),[_0x2404ab(0x1f7),'reportPharmacyHeader','reportActionHeader'][_0x2404ab(0x22d)](_0x4088d1=>document[_0x2404ab(0x21b)](_0x4088d1)[_0x2404ab(0x236)][_0x2404ab(0x147)](_0x2404ab(0x272),!_0x1c7f46)),_0x46c750[_0x2404ab(0x22d)](_0x233782=>{const _0x3310f1=_0x2404ab,_0x716a11=getLatestDispensing(_0x233782),_0x3b0c38=document[_0x3310f1(0x176)]('tr');_0x3b0c38[_0x3310f1(0x106)]=_0x3310f1(0x24d),_0x3b0c38[_0x3310f1(0x217)]=_0x3310f1(0x1ab)+_0x233782[_0x3310f1(0x257)]+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x22>'+(_0x233782[_0x3310f1(0x285)]||_0x3310f1(0x12c))+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x1c7f46?'<td\x20class=\x22px-4\x20py-3\x22>'+(PHARMACY_LIST[_0x233782[_0x3310f1(0x1bb)]]||_0x233782['pharmacyId'])+_0x3310f1(0x137):'')+_0x3310f1(0x188)+_0x233782[_0x3310f1(0x135)]+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x22>'+(_0x233782[_0x3310f1(0x168)]||[])[_0x3310f1(0x209)](',\x20')+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22px-4\x20py-3\x22>'+_0x716a11['dispensingDate']+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x1c7f46?'<td\x20class=\x22px-4\x20py-3\x22>'+(_0x233782['createdBy']||_0x3310f1(0x12c))[_0x3310f1(0x1b5)]('@')[0x0]+_0x3310f1(0x137):'')+_0x3310f1(0x142)+(_0x1c7f46?'<td\x20class=\x22px-4\x20py-3\x20text-center\x20report-action-cell\x22><button\x20onclick=\x22confirmDeleteRecord(\x27'+_0x233782['id']+_0x3310f1(0x265)+_0x233782[_0x3310f1(0x257)]+'\x27,\x20\x27'+_0x233782['pharmacyId']+_0x3310f1(0x19e):'')+_0x3310f1(0x195),_0x2797b2['appendChild'](_0x3b0c38);}),document[_0x2404ab(0x21b)](_0x2404ab(0x114))[_0x2404ab(0x236)]['toggle'](_0x2404ab(0x272),!_0x1c7f46),showModal(_0x2404ab(0x1df));}catch(_0x5bc8bb){console[_0x2404ab(0x260)](_0x2404ab(0x25d),_0x5bc8bb),showMessage('حدث\x20خطأ\x20أثناء\x20إنشاء\x20تقرير\x20الوصفات\x20المنتهية.',_0x2404ab(0x10f));}finally{_0x374ef0['disabled']=![],_0x374ef0[_0x2404ab(0x186)]='عرض\x20التقرير';}};window['confirmDeleteRecord']=(_0x37f950,_0xdb2d26,_0x315b6c)=>{const _0x517c1c=_0x4e3bf4;recordIdToDelete=_0x37f950,pharmacyIdToDeleteFrom=_0x315b6c,document['getElementById'](_0x517c1c(0x1fc))[_0x517c1c(0x186)]='هل\x20أنت\x20متأكد\x20من\x20حذف\x20وصفة\x20المريض:\x20'+_0xdb2d26+_0x517c1c(0x185),showModal(_0x517c1c(0x1d9));};const executeDelete=async()=>{const _0x3b09c2=_0x4e3bf4;if(!recordIdToDelete||!pharmacyIdToDeleteFrom)return;const _0x3f94a0=document[_0x3b09c2(0x21b)]('confirmDeleteButton');_0x3f94a0['disabled']=!![];try{await deleteDoc(doc(db,'pharmacies/'+pharmacyIdToDeleteFrom+_0x3b09c2(0x177)+recordIdToDelete)),isDataFetchedForAdmin=![],sessionStorage[_0x3b09c2(0x183)](_0x3b09c2(0x255)),showMessage(_0x3b09c2(0x163),_0x3b09c2(0x1ad)),closeModal(_0x3b09c2(0x1d9)),await showNoRefillReport();}catch(_0x2df453){console[_0x3b09c2(0x260)](_0x3b09c2(0x23e),_0x2df453),showMessage('حدث\x20خطأ\x20أثناء\x20محاولة\x20الحذف.',_0x3b09c2(0x10f));}finally{recordIdToDelete=null,pharmacyIdToDeleteFrom=null,_0x3f94a0['disabled']=![];}},confirmBulkDeleteExpired=async()=>{const _0x31ab68=_0x4e3bf4,_0x1c0053=document[_0x31ab68(0x21b)](_0x31ab68(0x194));_0x1c0053['disabled']=!![],_0x1c0053[_0x31ab68(0x217)]=_0x31ab68(0x141);try{let _0x101e48=await getRecordsForCurrentUserScope();if(!_0x101e48)throw new Error(_0x31ab68(0x264));const _0x40b636=_0x101e48['filter'](_0x4eccdd=>getLatestDispensing(_0x4eccdd)?.[_0x31ab68(0x14a)]===0x0);if(_0x40b636[_0x31ab68(0x1c3)]===0x0){showMessage('لا\x20توجد\x20وصفات\x20منتهية\x20للحذف.',_0x31ab68(0x102));return;}document['getElementById'](_0x31ab68(0x275))[_0x31ab68(0x186)]=_0x31ab68(0x13b)+_0x40b636[_0x31ab68(0x1c3)]+'\x20وصفة\x20منتهية\x20بشكل\x20نهائي.\x20هل\x20أنت\x20متأكد؟',showModal(_0x31ab68(0x138));}catch(_0x5c8f51){showMessage(_0x31ab68(0x161),_0x31ab68(0x10f));}finally{_0x1c0053[_0x31ab68(0x129)]=![],_0x1c0053['textContent']=_0x31ab68(0x11d);}},executeBulkDeleteExpired=async()=>{const _0x47493a=_0x4e3bf4,_0x16a051=document['getElementById'](_0x47493a(0x156));_0x16a051[_0x47493a(0x129)]=!![],_0x16a051[_0x47493a(0x217)]=_0x47493a(0x141);try{let _0x2ec370=await getRecordsForCurrentUserScope(!![]);if(!_0x2ec370)throw new Error(_0x47493a(0x26a));const _0x15791e=_0x2ec370[_0x47493a(0x215)](_0x2396c8=>getLatestDispensing(_0x2396c8)?.['durationDays']===0x0);if(_0x15791e[_0x47493a(0x1c3)]===0x0){closeModal('confirmBulkDeleteModal'),showMessage(_0x47493a(0x173),_0x47493a(0x1de));return;}const _0x2539e0=writeBatch(db);_0x15791e['forEach'](_0x5ca8d7=>{const _0x2c2123=_0x47493a,_0x348fa3=doc(db,'pharmacies/'+_0x5ca8d7[_0x2c2123(0x1bb)]+_0x2c2123(0x1d8),_0x5ca8d7['id']);_0x2539e0[_0x2c2123(0x1da)](_0x348fa3);}),await _0x2539e0[_0x47493a(0x249)](),isDataFetchedForAdmin=![],sessionStorage['removeItem'](_0x47493a(0x255)),showMessage(_0x47493a(0x17d)+_0x15791e[_0x47493a(0x1c3)]+_0x47493a(0x22b),_0x47493a(0x1ad));}catch(_0xfe6feb){console[_0x47493a(0x260)]('Bulk\x20Delete\x20Error:',_0xfe6feb),showMessage(_0x47493a(0x19f),'red');}finally{_0x16a051[_0x47493a(0x129)]=![],_0x16a051['textContent']=_0x47493a(0x13e),closeModal(_0x47493a(0x138));}};window['confirmDeleteMedication']=_0x3c3003=>{const _0x165f15=_0x4e3bf4;medNameToDelete=_0x3c3003,document[_0x165f15(0x21b)]('confirmMedDeleteMessage')[_0x165f15(0x186)]=_0x165f15(0x145)+_0x3c3003+_0x165f15(0x242),showModal('confirmMedDeleteModal');};const executeDeleteMedication=async()=>{const _0x1ae95b=_0x4e3bf4;if(!medNameToDelete)return;const _0x12573e=document[_0x1ae95b(0x21b)]('confirmMedDeleteButton');_0x12573e['disabled']=!![];try{await deleteDoc(doc(db,_0x1ae95b(0x179),medNameToDelete)),showMessage('تم\x20حذف\x20\x22'+medNameToDelete+'\x22\x20بنجاح.','green'),await loadAvailableMedsFromFirestore();}catch(_0x154545){console[_0x1ae95b(0x260)](_0x1ae95b(0x246),_0x154545),showMessage('حدث\x20خطأ\x20أثناء\x20محاولة\x20الحذف.','red');}finally{closeModal(_0x1ae95b(0x210)),medNameToDelete=null,document[_0x1ae95b(0x21b)](_0x1ae95b(0x12f))[_0x1ae95b(0x236)][_0x1ae95b(0x184)]('hidden'),document[_0x1ae95b(0x21b)]('medicationSearch')['value']='',_0x12573e[_0x1ae95b(0x129)]=![];}};window[_0x4e3bf4(0x24c)]=()=>{const _0x25f326=_0x4e3bf4;setupPharmacySearch(),document['getElementById'](_0x25f326(0x190))[_0x25f326(0x237)]('submit',handleLogin),document[_0x25f326(0x21b)]('logoutButton')['addEventListener'](_0x25f326(0x228),handleLogout),document[_0x25f326(0x21b)]('medicationForm')[_0x25f326(0x237)]('submit',handleFormSubmit),[_0x25f326(0x1a1),'refillDuration'][_0x25f326(0x22d)](_0x499338=>document[_0x25f326(0x21b)](_0x499338)[_0x25f326(0x237)]('change',calculateRefillDate)),document['getElementById']('checkPrescriptionButton')[_0x25f326(0x237)](_0x25f326(0x228),checkPrescription),document['getElementById'](_0x25f326(0x267))[_0x25f326(0x237)](_0x25f326(0x228),filterRecords),document[_0x25f326(0x21b)](_0x25f326(0x165))['addEventListener'](_0x25f326(0x228),clearSearch),document['getElementById']('noRefillReportButton')[_0x25f326(0x237)](_0x25f326(0x228),showNoRefillReport),document[_0x25f326(0x21b)]('userReportButton')['addEventListener']('click',showUserDispensingReport),document[_0x25f326(0x21b)](_0x25f326(0x170))[_0x25f326(0x237)](_0x25f326(0x228),showUserSummaryReport),document[_0x25f326(0x21b)](_0x25f326(0x21c))[_0x25f326(0x237)](_0x25f326(0x228),()=>navigateTo(_0x25f326(0x1c1))),document[_0x25f326(0x21b)](_0x25f326(0x25e))[_0x25f326(0x237)](_0x25f326(0x273),autofillPatientDataOnIdBlur),document[_0x25f326(0x21b)](_0x25f326(0x1ce))[_0x25f326(0x237)](_0x25f326(0x149),handleFileSelection),document['getElementById'](_0x25f326(0x134))[_0x25f326(0x237)]('click',handleImportProcess),document[_0x25f326(0x21b)]('cancelDeleteButton')[_0x25f326(0x237)](_0x25f326(0x228),()=>closeModal(_0x25f326(0x1d9))),document['getElementById'](_0x25f326(0x224))[_0x25f326(0x237)]('click',executeDelete),document[_0x25f326(0x21b)](_0x25f326(0x125))['addEventListener'](_0x25f326(0x228),()=>closeModal('confirmMedDeleteModal')),document[_0x25f326(0x21b)](_0x25f326(0x18b))[_0x25f326(0x237)](_0x25f326(0x228),executeDeleteMedication),document[_0x25f326(0x21b)](_0x25f326(0x194))[_0x25f326(0x237)](_0x25f326(0x228),confirmBulkDeleteExpired),document[_0x25f326(0x21b)]('cancelBulkDeleteButton')[_0x25f326(0x237)](_0x25f326(0x228),()=>closeModal(_0x25f326(0x138))),document[_0x25f326(0x21b)](_0x25f326(0x156))[_0x25f326(0x237)](_0x25f326(0x228),executeBulkDeleteExpired),document[_0x25f326(0x21b)](_0x25f326(0x21e))[_0x25f326(0x237)](_0x25f326(0x228),()=>closeModal(_0x25f326(0x17b))),document['getElementById'](_0x25f326(0x277))[_0x25f326(0x237)](_0x25f326(0x228),()=>closeModal(_0x25f326(0x17b))),document['getElementById'](_0x25f326(0x14d))['addEventListener']('click',()=>closeModal('historyModal')),document[_0x25f326(0x21b)](_0x25f326(0x268))['addEventListener']('click',()=>closeModal('historyModal')),document['getElementById'](_0x25f326(0x1d1))['addEventListener'](_0x25f326(0x228),()=>closeModal(_0x25f326(0x1df))),document[_0x25f326(0x21b)](_0x25f326(0x20f))['addEventListener'](_0x25f326(0x228),()=>closeModal(_0x25f326(0x1df))),document[_0x25f326(0x21b)]('closeUserReportModalButton')[_0x25f326(0x237)](_0x25f326(0x228),()=>closeModal(_0x25f326(0x1e9))),document['getElementById'](_0x25f326(0x208))[_0x25f326(0x237)](_0x25f326(0x228),()=>closeModal('userReportModal')),document[_0x25f326(0x21b)]('closeSummaryReportModalButton')['addEventListener'](_0x25f326(0x228),()=>closeModal(_0x25f326(0x127))),document[_0x25f326(0x21b)](_0x25f326(0x20b))[_0x25f326(0x237)]('click',()=>closeModal(_0x25f326(0x127))),document['getElementById'](_0x25f326(0x114))['addEventListener'](_0x25f326(0x228),()=>exportTableToExcel(_0x25f326(0x1aa),_0x25f326(0x1ea)+formatDate(new Date())+_0x25f326(0x1d7))),document[_0x25f326(0x21b)](_0x25f326(0x222))[_0x25f326(0x237)](_0x25f326(0x228),()=>exportTableToExcel('userReportTable',_0x25f326(0x193)+formatDate(new Date())+'.xlsx')),document['getElementById'](_0x25f326(0x101))[_0x25f326(0x237)]('click',()=>exportTableToExcel(_0x25f326(0x16c),_0x25f326(0x10c)+formatDate(new Date())+_0x25f326(0x1d7))),document[_0x25f326(0x237)](_0x25f326(0x12b),_0x3423a8=>{const _0x3271c5=_0x25f326;_0x3423a8[_0x3271c5(0x18a)]===_0x3271c5(0x258)&&document['querySelectorAll'](_0x3271c5(0x248))[_0x3271c5(0x22d)](_0x5c2d04=>{const _0x21c35a=_0x3271c5;if(_0x5c2d04[_0x21c35a(0x236)][_0x21c35a(0x24f)](_0x21c35a(0x14e)))closeModal(_0x5c2d04['id']);});});};
    </script>
</head>

<body class="p-4 md:p-8">
    <div id="loginContainer" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl border">
            <img src="https://i.postimg.cc/HsrDVPzq/logo.png" alt="Logo" class="mx-auto h-16 w-auto mb-4">
            <h2 class="text-3xl font-bold text-center text-blue-800 mb-6">United Pharmacy</h2>
			<h3 class="text-xl font-bold text-center text-gray-800 mb-6">تسجيل الدخول</h3>
            <form id="loginForm">
                <div id="pharmacyInputArea" class="mb-4 relative"><label for="pharmacyIdInput" class="block text-sm font-bold mb-1">الصيدلية</label><input type="text" id="pharmacyIdInput" autocomplete="off" required class="w-full p-3 border rounded-lg" placeholder="ابحث بالاسم أو الرقم"><div id="pharmacySuggestions" class="absolute z-30 w-full bg-white border mt-1 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden"></div></div>
                <div class="mb-4"><label for="usernameInput" class="block text-sm font-bold mb-1">اسم المستخدم</label><input type="text" id="usernameInput" autocomplete="off" required class="w-full p-3 border rounded-lg" placeholder="أدخل اسم المستخدم"></div>
                <div class="mb-6"><label for="passwordInput" class="block text-sm font-bold mb-1">كلمة المرور</label><input type="password" id="passwordInput" required class="w-full p-3 border rounded-lg" placeholder="••••••••"></div>
                <div id="loginError" class="hidden p-3 mb-4 text-sm rounded-lg bg-red-100 text-red-700"></div>
                <div><button type="submit" class="w-full flex justify-center py-3 px-4 rounded-lg shadow-md text-white bg-blue-600 hover:bg-blue-700">دخول</button></div>
            </form>
            <p class="text-center text-l font-bold text-red-700 mt-7">Created by: Dr.Abdelrahman Baiomy</p>
			<p class="text-center text-l font-bold text-blue-900 mt-1">As a part of </p>
			<p class="text-center text-l font-bold text-red-700 mt-1">Taif Power Team</p>
        </div>
    </div>
    
    <div id="appContainer" class="max-w-4xl mx-auto hidden">
        <header class="text-center mb-8 relative">
            <img src="https://i.postimg.cc/HsrDVPzq/logo.png" alt="Logo" class="mx-auto h-20 w-auto mb-2">
            <h1 class="text-4xl font-bold text-blue-800">United Pharmacy</h1>
			<h1 class="text-l font-bold text-gray-600 mt-6">تتبع صرف علاج وصفتي</h1>
            <div id="userInfo" class="hidden absolute top-0 left-0 flex items-center space-x-2 space-x-reverse text-sm bg-gray-100 p-2 rounded-lg">
                <span class="font-bold">مرحباً, <span id="loggedInUserDisplay" class="font-bold text-blue-600"></span></span>
                <span id="pharmacyDisplayContainer" class="font-bold">| الصيدلية: <span id="pharmacyIdDisplay" class="font-bold text-green-600"></span></span>
                <button id="logoutButton" class="text-red-500 hover:text-red-700 font-semibold">تسجيل الخروج</button>
            </div>
        </header>

        <div id="loadingStatus" class="mb-4 text-sm text-center text-gray-600"></div>
        <div id="messageBox" class="hidden"></div>
        
        <div id="navigationTabs" class="flex justify-center border-b mb-6">
            <button id="navDispense" class="px-6 py-3 text-lg font-semibold text-gray-500 border-b-2 border-transparent hover:text-blue-600">صرف وصفة</button>
        </div>

        <div id="dispenseView">
            <div id="adminViewMessage" class="hidden bg-green-100 border-l-4 border-green-500 text-green-900 p-4 mb-6 rounded-md" role="alert">
                <p class="font-bold">وضع المدير</p>
                <div id="adminPharmacyList"></div>
                 <!-- 
                    ********************************************************************************
                    *** ملاحظة هامة جداً للمطور ***
                    لجعل التحسينات الجديدة تعمل، يجب عليك إنشاء فهارس (Indexes) في قاعدة بيانات Firestore.
                    
                    الخطوات:
                    1. اذهب إلى لوحة تحكم Firebase -> Firestore Database -> Indexes.
                    
                    2. **الفهرس الأول (موجود غالباً):**
                       - `Collection ID`: `records`
                       - `Fields`: `idNumber` (Ascending), `prescriptionNumber` (Ascending)
                       - `Query scope`: `Collection group`

                    3. **الفهرس الثاني (مطلوب للبحث بالاسم):**
                       - `Collection ID`: `records`
                       - `Fields`: `patientName` (Ascending)
                       - `Query scope`: `Collection group`
                    
                    قد يستغرق بناء الفهرس الجديد بضع دقائق. هذه الخطوة ضرورية لعمل البحث السريع.
                    ********************************************************************************
                -->
            </div>

            <div id="dataEntryForm" class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 border">
                <h2 class="text-xl font-semibold text-blue-800 mb-6 border-b pb-2">صرف أو إعادة صرف وصفة</h2>
                <form id="medicationForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="adminPharmacySelectorContainer" class="md:col-span-2 hidden">
                        <label for="adminPharmacySelector" class="block text-sm font-bold mb-1 text-gray-900">اختر الصيدلية</label>
                        <select id="adminPharmacySelector" name="adminPharmacySelector" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50"></select>
                    </div>
                    <div class="md:col-span-2"><label for="prescriptionNumber" class="block text-sm font-bold mb-1">أدخل رقم الوصفة <span class="text-red-500">*</span></label><div class="flex"><input type="text" id="prescriptionNumber" name="prescriptionNumber" required class="flex-grow p-3 border rounded-r-lg" placeholder="أدخل رقم الوصفة"><button type="button" id="checkPrescriptionButton" class="bg-blue-900 text-white p-3 rounded-l-lg hover:bg-blue-700">تحقق</button></div></div>
                    <div><label for="patientName" class="block text-sm font-bold mb-1">اسم المريض <span class="text-red-500">*</span></label><input type="text" id="patientName" name="patientName" required class="w-full p-3 border rounded-lg" placeholder="الاسم كاملاً"></div>
                    <div><label for="idNumber" class="block text-sm font-bold mb-1">رقم الهوية <span class="text-red-500">*</span></label><input type="text" id="idNumber" name="idNumber" required class="w-full p-3 border rounded-lg" placeholder="رقم الهوية"></div>
                    <div class="md:col-span-2"><label for="phoneNumber" class="block text-sm font-bold mb-1">رقم الهاتف <span class="text-red-500">*</span></label><input type="tel" id="phoneNumber" name="phoneNumber" class="w-full p-3 border rounded-lg text-right" placeholder="ادخل 10 أرقام" required pattern="[0-9]{10}" title="يجب إدخال 10 أرقام بالضبط."></div>
                    <div id="medicationInputArea" class="relative md:col-span-2"><label class="block text-sm font-bold mb-1">أضف الأدوية <span class="text-red-500">*</span></label><div class="flex"><input type="text" id="medicationSearch" class="flex-grow p-3 border rounded-r-lg" placeholder="ابحث وأضف"><button type="button" id="addMedicationButton" class="bg-blue-900 text-white p-3 rounded-l-lg hover:bg-blue-700">أضف</button></div><div id="medicationSuggestions" class="absolute z-20 w-full bg-white border mt-1 rounded-lg shadow-lg max-h-48 overflow-y-scroll hidden"></div><div id="selectedMedicationsContainer" class="mt-3 p-3 bg-gray-50 border rounded-lg min-h-[40px]"></div><input type="hidden" id="medicationCount" name="medicationCount" value="0"></div>
                    <div><label for="dispensingDate" class="block text-sm font-bold mb-1">تاريخ الصرف <span class="text-red-500">*</span></label><input type="date" id="dispensingDate" name="dispensingDate" required class="w-full p-3 border rounded-lg"></div>
                    <div><label for="refillDuration" class="block text-sm font-bold mb-1">فترة الإعادة <span class="text-red-500">*</span></label><select id="refillDuration" name="refillDuration" required class="w-full p-3 border rounded-lg"><option value="" disabled selected>اختر</option><option value="0">لا يوجد اعادة صرف</option><option value="24">شهر</option><option value="48">شهرين</option><option value="72">3 شهور</option></select></div>
                    <div class="md:col-span-2"><div class="mt-2 p-3 bg-blue-50 rounded-lg border"><p class="font-bold text-blue-800">تاريخ الإعادة المحسوب:</p><p id="refillDateDisplay" class="font-semibold text-lg">--/--/----</p></div><input type="hidden" id="refillDate" name="refillDate"></div>
                    <div class="md:col-span-2 mt-4"><button type="submit" id="submitButton" class="w-full py-3 px-4 rounded-lg shadow-md text-white bg-blue-900 hover:bg-blue-700">حفظ سجل جديد</button></div>
                </form>
            </div>
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 border">
                <h2 class="text-xl font-semibold text-blue-800 mb-6 border-b pb-2">البحث بالسجلات</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div><label for="startDateFilter" class="block text-sm font-bold mb-1">من تاريخ (إعادة صرف):</label><input type="date" id="startDateFilter" class="w-full p-3 border rounded-lg"></div>
                    <div><label for="endDateFilter" class="block text-sm font-bold mb-1">إلى تاريخ (إعادة صرف):</label><input type="date" id="endDateFilter" class="w-full p-3 border rounded-lg"></div>
                    <div><label for="generalSearchFilter" class="block text-sm font-bold mb-1">الهوية/الهاتف/الوصفة:</label><input type="text" id="generalSearchFilter" class="w-full p-3 border rounded-lg" placeholder="بحث شامل"></div>
                    <div><label for="medicationFilter" class="block text-sm font-bold mb-1">اسم العلاج:</label><input type="text" id="medicationFilter" class="w-full p-3 border rounded-lg" placeholder="مثال: Lantus"></div>
                </div>
                 <div class="mt-4 flex flex-col sm:flex-row justify-end gap-2">
                    <button id="searchButton" type="button" class="py-3 px-6 rounded-lg shadow-md text-white bg-blue-900 hover:bg-blue-700 flex items-center justify-center">بحث</button>
                    <button id="clearSearchButton" type="button" class="py-3 px-6 rounded-lg shadow-md text-gray-800 bg-gray-200 hover:bg-gray-300">مسح</button>
                </div>
            </div>
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 border">
                <h2 class="text-xl font-semibold text-center text-red-800 mb-6 border-b pb-2">التقارير المتقدمة</h2>
                <div class="border-b pb-4 mb-4">
                    <h3 class="font-bold text-blue-900">تقرير الوصفات المنتهية</h3>
                    <p class="text-sm text-gray-500 mb-2">عرض كل الوصفات التي ليس لها إعادة صرف</p>
                    <div class="flex gap-2 items-center">
                        <button id="noRefillReportButton" class="py-2 px-5 rounded-lg shadow-md text-white bg-red-800 hover:bg-red-900 flex items-center justify-center">عرض التقرير</button>
                        <!-- *** إضافة: زر الحذف الجماعي *** -->
                        <button id="deleteAllExpiredButton" class="hidden py-2 px-5 rounded-lg shadow-md text-white bg-red-900 hover:bg-red-700 flex items-center justify-center">حذف كل الوصفات المنتهية</button>
                    </div>
                </div>
                <div class="border-b pb-4 mb-4">
                     <h3 class="font-bold text-blue-900">تقرير صرف المستخدم (مفصّل)</h3>
                    <p class="text-sm text-gray-500 mb-2">عرض تفاصيل الوصفات التي سجلها مستخدم معين خلال فترة محددة</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div id="userReportSelectorContainer" class="hidden">
                            <label for="userReportSelector" class="block text-sm font-bold mb-1">اختر المستخدم:</label>
                            <select id="userReportSelector" class="w-full p-3 border rounded-lg"></select>
                        </div>
                        <div><label for="userReportStartDate" class="block text-sm font-bold mb-1">من تاريخ:</label><input type="date" id="userReportStartDate" class="w-full p-3 border rounded-lg"></div>
                        <div><label for="userReportEndDate" class="block text-sm font-bold mb-1">إلى تاريخ:</label><input type="date" id="userReportEndDate" class="w-full p-3 border rounded-lg"></div>
                        <div class="md:col-start-3"><button id="userReportButton" class="w-full py-3 px-5 rounded-lg shadow-md text-white bg-green-900 hover:bg-green-800 flex items-center justify-center">عرض تقريري</button></div>
                    </div>
                </div>
                <div id="summaryReportContainer" class="hidden">
                     <h3 class="font-bold text-blue-900">تقرير أداء المستخدمين (تجميعي)</h3>
                    <p class="text-sm text-gray-500 mb-2">عرض العدد الإجمالي للوصفات المسجلة لكل مستخدم يوميًا خلال فترة محددة.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div><label for="summaryReportStartDate" class="block text-sm font-bold mb-1">من تاريخ:</label><input type="date" id="summaryReportStartDate" class="w-full p-3 border rounded-lg"></div>
                        <div><label for="summaryReportEndDate" class="block text-sm font-bold mb-1">إلى تاريخ:</label><input type="date" id="summaryReportEndDate" class="w-full p-3 border rounded-lg"></div>
                        <div class="md:col-start-3"><button id="summaryReportButton" class="w-full py-3 px-5 rounded-lg shadow-md text-white bg-indigo-700 hover:bg-indigo-800 flex items-center justify-center">عرض التقرير</button></div>
                    </div>
                </div>
            </div>
            <div id="excelImportContainer" class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 border hidden">
                <h2 class="text-xl font-semibold text-center text-purple-800 mb-6 border-b pb-2">استيراد سجلات الوصفات من Excel</h2>
                <p class="text-sm text-gray-600 mb-4">اختر الصيدلية أولاً، ثم ارفع ملف Excel لإضافة سجلات وصفات جديدة. تأكد من أن الملف مطابق للصيغة المطلوبة (xlsx).</p>
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
                    <label for="excelFile" class="cursor-pointer py-2 px-5 rounded-lg shadow-md text-white bg-blue-900 hover:bg-blue-800">
                        اختر ملف...
                    </label>
                    <span id="fileNameDisplay" class="text-sm text-gray-600">لم يتم اختيار أي ملف</span>
                    <button id="importExcelButton" type="button" class="ml-auto w-full sm:w-auto py-2 px-6 rounded-lg shadow-md text-white bg-purple-800 hover:bg-purple-900 flex items-center justify-center gap-2">استيراد</button>
                </div>
            </div>
        </div>

        <footer class="text-center mt-10 mb-4">
		<p class="text-center text-l font-bold text-red-700 mt-7">Created by: Dr.Abdelrahman Baiomy</p><p class="text-center text-l font-bold text-blue-900 mt-1">As a part of </p><p class="text-center text-l font-bold text-red-700 mt-1">Taif Power Team</p>
		</footer>
    </div>
    
    <!-- Modals -->
    <div id="resultsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"><div class="p-5 border-b flex justify-between items-center"><h3 class="text-xl font-bold text-blue-700">نتائج البحث</h3><button id="closeResultsModalButton" type="button"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div class="p-5 overflow-y-auto flex-grow"><div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-6 py-3 text-right text-xs uppercase">المريض</th><th class="px-6 py-3 text-right text-xs uppercase">الهوية</th><th class="px-6 py-3 text-right text-xs uppercase">الهاتف</th><th id="pharmacyHeader" class="px-6 py-3 text-right text-xs uppercase hidden">الصيدلية</th><th class="px-6 py-3 text-right text-xs uppercase">الوصفة</th><th class="px-6 py-3 text-right text-xs uppercase">الأدوية</th><th class="px-6 py-3 text-right text-xs uppercase">الإعادة</th><th id="createdByHeader" class="px-6 py-3 text-right text-xs uppercase hidden">المسجل</th><th class="px-6 py-3 text-center text-xs uppercase">السجل</th></tr></thead><tbody id="modalRecordsBody" class="divide-y"></tbody></table></div><div id="noResultsModal" class="hidden text-center py-8">لا توجد سجلات تطابق بحثك.</div></div><div class="p-4 border-t"><button id="footerCloseResultsModalButton" type="button" class="w-full py-2 rounded-lg bg-gray-200 hover:bg-gray-300">إغلاق</button></div></div></div>
    <div id="historyModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-[60] p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] flex flex-col"><div class="p-5 border-b flex justify-between items-center"><h3 class="text-xl font-bold">سجل الصرف: <span id="historyPatientName"></span></h3><button id="closeHistoryModalButton" type="button"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div class="p-5 overflow-y-auto flex-grow"><table class="min-w-full divide-y"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-3 text-center text-xs uppercase">#</th><th class="px-4 py-3 text-center text-xs uppercase">تاريخ الصرف</th><th class="px-4 py-3 text-center text-xs uppercase">المدة</th><th class="px-4 py-3 text-center text-xs uppercase">تاريخ الإعادة</th><th class="px-4 py-3 text-right text-xs uppercase">الأدوية</th></tr></thead><tbody id="historyModalBody" class="divide-y"></tbody></table></div><div class="p-4 border-t"><button id="footerCloseHistoryModalButton" type="button" class="w-full py-2 rounded-lg bg-gray-200 hover:bg-gray-300">إغلاق</button></div></div></div>
    <div id="reportModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col"><div class="p-5 border-b flex justify-between items-center"><h3 class="text-xl font-bold text-red-700">تقرير الوصفات المنتهية</h3><button id="closeReportModalButton" type="button"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div class="p-5 overflow-y-auto flex-grow"><table id="noRefillReportTable" class="min-w-full divide-y"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-3 text-right text-xs uppercase">المريض</th><th class="px-4 py-3 text-right text-xs uppercase">رقم الهاتف</th><th id="reportPharmacyHeader" class="px-4 py-3 text-right text-xs uppercase hidden">الصيدلية</th><th class="px-4 py-3 text-right text-xs uppercase">الوصفة</th><th class="px-4 py-3 text-right text-xs uppercase">الأدوية</th><th class="px-4 py-3 text-right text-xs uppercase">آخر صرف</th><th id="reportCreatedByHeader" class="px-4 py-3 text-right text-xs uppercase hidden">المسجل</th><th id="reportActionHeader" class="px-4 py-3 text-center text-xs uppercase hidden">إجراء</th></tr></thead><tbody id="reportModalBody" class="divide-y"></tbody></table><div id="noResultsReport" class="hidden text-center py-8">لا توجد وصفات منتهية حالياً.</div></div><div class="p-4 border-t flex gap-2"><button id="exportNoRefillReportButton" type="button" class="w-full py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white hidden">تصدير إلى Excel</button><button id="footerCloseReportModalButton" type="button" class="w-full py-2 rounded-lg bg-gray-200 hover:bg-gray-300">إغلاق</button></div></div></div>
    <div id="userReportModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"><div class="p-5 border-b flex justify-between items-center"><div><h3 class="text-xl font-bold text-green-700">تقرير الصرف للمستخدم</h3><p id="userReportInfo" class="text-sm text-gray-600"></p></div><button id="closeUserReportModalButton" type="button"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div class="p-5 overflow-y-auto flex-grow"><div id="userReportSummary" class="mb-4 font-bold text-lg p-3 bg-green-50 rounded-md"></div><table id="userReportTable" class="min-w-full divide-y"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-3 text-right text-xs uppercase">تاريخ الصرف</th><th class="px-4 py-3 text-right text-xs uppercase">المريض</th><th class="px-4 py-3 text-right text-xs uppercase">رقم الهاتف</th><th class="px-4 py-3 text-right text-xs uppercase">رقم الوصفة</th><th id="dispenserHeader" class="px-4 py-3 text-right text-xs uppercase hidden">المستخدم الصارف</th><th class="px-4 py-3 text-right text-xs uppercase">الصيدلية</th><th class="px-4 py-3 text-right text-xs uppercase">الأدوية المصروفة</th></tr></thead><tbody id="userReportModalBody" class="divide-y"></tbody></table><div id="noResultsUserReport" class="hidden text-center py-8">لا توجد وصفات مصروفة بواسطة هذا المستخدم في الفترة المحددة.</div></div><div class="p-4 border-t flex gap-2"><button id="exportUserReportButton" type="button" class="w-full py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white hidden">تصدير إلى Excel</button><button id="footerCloseUserReportModalButton" type="button" class="w-full py-2 rounded-lg bg-gray-200 hover:bg-gray-300">إغلاق</button></div></div></div>
    <div id="summaryReportModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col"><div class="p-5 border-b flex justify-between items-center"><div><h3 class="text-xl font-bold text-indigo-700">تقرير أداء المستخدمين (تجميعي)</h3><p id="summaryReportInfo" class="text-sm text-gray-600"></p></div><button id="closeSummaryReportModalButton" type="button"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div class="p-5 overflow-y-auto flex-grow"><div id="summaryReportSummary" class="mb-4 font-bold text-lg p-3 bg-indigo-50 rounded-md"></div><table id="summaryReportTable" class="min-w-full divide-y"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-3 text-right text-xs uppercase">اسم المستخدم</th><th class="px-4 py-3 text-right text-xs uppercase">التاريخ</th><th class="px-4 py-3 text-right text-xs uppercase">الصيدلية</th><th class="px-4 py-3 text-center text-xs uppercase">عدد الوصفات المسجلة</th></tr></thead><tbody id="summaryReportModalBody" class="divide-y"></tbody></table><div id="noResultsSummaryReport" class="hidden text-center py-8">لا توجد بيانات لعرضها في الفترة المحددة.</div></div><div class="p-4 border-t flex gap-2"><button id="exportSummaryReportButton" type="button" class="w-full py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white">تصدير إلى Excel</button><button id="footerCloseSummaryReportModalButton" type="button" class="w-full py-2 rounded-lg bg-gray-200 hover:bg-gray-300">إغلاق</button></div></div></div>
    <div id="confirmDeleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[70] p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h3 class="text-lg font-bold mb-4">تأكيد الحذف</h3><p id="confirmDeleteMessage" class="text-sm text-gray-600 mb-6">هل أنت متأكد؟</p><div class="flex justify-center gap-4"><button id="cancelDeleteButton" class="py-2 px-6 rounded-lg bg-gray-200 hover:bg-gray-300">إلغاء</button><button id="confirmDeleteButton" class="py-2 px-6 rounded-lg bg-red-600 hover:bg-red-700 text-white">تأكيد الحذف</button></div></div></div>
    <div id="confirmMedDeleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[80] p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h3 class="text-lg font-bold mb-4 text-red-700">تأكيد حذف دواء</h3><p id="confirmMedDeleteMessage" class="text-sm text-gray-600 mb-6">هل أنت متأكد؟</p><div class="flex justify-center gap-4"><button id="cancelMedDeleteButton" class="py-2 px-6 rounded-lg bg-gray-200 hover:bg-gray-300">إلغاء</button><button id="confirmMedDeleteButton" class="py-2 px-6 rounded-lg bg-red-600 hover:bg-red-700 text-white">تأكيد الحذف</button></div></div></div>
    <!-- *** إضافة: نافذة تأكيد الحذف الجماعي *** -->
    <div id="confirmBulkDeleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-[70] p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h3 class="text-lg font-bold mb-4 text-red-700">تأكيد الحذف الجماعي</h3><p id="confirmBulkDeleteMessage" class="text-sm text-gray-600 mb-6"></p><div class="flex justify-center gap-4"><button id="cancelBulkDeleteButton" class="py-2 px-6 rounded-lg bg-gray-200 hover:bg-gray-300">إلغاء</button><button id="confirmBulkDeleteButton" class="py-2 px-6 rounded-lg bg-red-600 hover:bg-red-700 text-white">نعم، قم بالحذف</button></div></div></div>
</body>
</html>


